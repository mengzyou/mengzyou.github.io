<!doctype html><html lang=zh><head><title>加载virtio驱动的Windows10安装镜像</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/application.fb9df7e952c9dccf496d00faec07de633aae460f909bbba4b5e0ad22f5887d73.css integrity="sha256-+5336VLJ3M9JbQD67AfeYzquRg+Qm7ukteCtIvWIfXM="><link rel=icon type=image/png href=/images/site/favicon_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png><meta property="og:title" content="加载virtio驱动的Windows10安装镜像"><meta property="og:description" content="本文描述了如何在Windows上创建加载了virtio驱动的iso安装镜像"><meta property="og:type" content="article"><meta property="og:url" content="/zh/posts/windows/windows10-virtio-image/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-08T16:42:22+08:00"><meta property="article:modified_time" content="2021-06-08T16:42:22+08:00"><meta name=description content="本文描述了如何在Windows上创建加载了virtio驱动的iso安装镜像"><script src=https://cdn.counter.dev/script.js data-id=2905461c-37df-49f9-a4ca-0ea1ba64543a data-utcoffset=1></script></head><body class="type-posts kind-page" data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/zh/><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png alt=Logo>
Mengz's Space ...</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=menu-icon-center src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme"></a>
<a class="dropdown-item nav-link" href=# data-scheme=dark><img class=menu-icon-center src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a>
<a class="dropdown-item nav-link" href=# data-scheme=system><img class=menu-icon-center src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/zh/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/zh/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/k8s/>Kubernetes</a><ul><li><a href=/zh/posts/k8s/health-checks/ title=K8S健康检查最佳实践>K8S健康检查最佳实践</a></li><li><a href=/zh/posts/k8s/kubectl-plugins/ title=扩展你的KUBECTL功能>扩展你的KUBECTL功能</a></li><li><a href=/zh/posts/k8s/lightweight-k3s/ title=轻量级Kubernetes集群-K3S>轻量级Kubernetes集群-K3S</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/linux/>LINUX</a><ul><li><a href=/zh/posts/linux/bumlebee-nvidia/ title=BUMBLEBEE禁用NVIDIA显卡>BUMBLEBEE禁用NVIDIA显卡</a></li><li><a href=/zh/posts/linux/systemd-hostnamectl/ title=HOSTNAMECTL管理主机名>HOSTNAMECTL管理主机名</a></li><li><a href=/zh/posts/linux/make-undeletable/ title=LINUX上创建不可删除文件>LINUX上创建不可删除文件</a></li><li><a href=/zh/posts/linux/network-packets/ title=LINUX上统计网络接口数据包>LINUX上统计网络接口数据包</a></li><li><a href=/zh/posts/linux/opensuse-zypper/ title=OPENSUSE上的ZYPPER包管理器>OPENSUSE上的ZYPPER包管理器</a></li><li><a href=/zh/posts/linux/opensuse-cronjob/ title=OPENSUSE上的定时任务>OPENSUSE上的定时任务</a></li><li><a href=/zh/posts/linux/systemd-systemctl/ title=SYSTEMCTL管理系统服务>SYSTEMCTL管理系统服务</a></li><li><a href=/zh/posts/linux/systemd-timer/ title=SYSTEMD定时服务>SYSTEMD定时服务</a></li><li><a href=/zh/posts/linux/opensuse-upgrade/ title="升级OPENSUSE LEAP">升级OPENSUSE LEAP</a></li><li><a href=/zh/posts/linux/wireguard-vpn/ title=在LINUX上配置WIREGUARD>在LINUX上配置WIREGUARD</a></li><li><a href=/zh/posts/linux/ubuntu-old-kernel/ title=在UBUNTU上删除旧的内核>在UBUNTU上删除旧的内核</a></li><li><a href=/zh/posts/linux/what-hardware/ title=查看硬件信息>查看硬件信息</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/zh/posts/windows/>Windows</a><ul class=active><li><a href=/zh/posts/windows/windows10-wsl2/ title=Windows10上安装WSL2>Windows10上安装WSL2</a></li><li><a class=active href=/zh/posts/windows/windows10-virtio-image/ title=加载virtio驱动的Windows10安装镜像>加载virtio驱动的Windows10安装镜像</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/container-tech/>容器技术</a><ul><li><a href=/zh/posts/container-tech/docker-live-restore/ title="DOCKER LIVERESTORE特性">DOCKER LIVERESTORE特性</a></li><li><a href=/zh/posts/container-tech/docker-sbom/ title="DOCKER SBOM镜像物料清单">DOCKER SBOM镜像物料清单</a></li><li><a href=/zh/posts/container-tech/dockerfile-best/ title=DOCKERFILE构建最佳实践>DOCKERFILE构建最佳实践</a></li><li><a href=/zh/posts/container-tech/docker-intro/ title=DOCKER入门>DOCKER入门</a></li><li><a href=/zh/posts/container-tech/mariadb-docker/ title=DOCKER构建MariaDB>DOCKER构建MariaDB</a></li><li><a href=/zh/posts/container-tech/docker-container-app/ title=DOCKER构建容器化应用>DOCKER构建容器化应用</a></li><li><a href=/zh/posts/container-tech/docker-wechat/ title=DOCKER运行微信桌面客户端>DOCKER运行微信桌面客户端</a></li><li><a href=/zh/posts/container-tech/docker-desktop-windows/ title="WINDOWS上的DOCKER DESKTOP">WINDOWS上的DOCKER DESKTOP</a></li><li><a href=/zh/posts/container-tech/docker-compose-v2/ title="开始使用DOCKER COMPOSE V2">开始使用DOCKER COMPOSE V2</a></li><li><a href=/zh/posts/container-tech/smallest-web-container/ title=最小化静态WEB容器实践>最小化静态WEB容器实践</a></li><li><a href=/zh/posts/container-tech/docker-mqtt-broker/ title=本地环境运行MQTT容器>本地环境运行MQTT容器</a></li><li><a href=/zh/posts/container-tech/docker-context-remote/ title=管理远程DOCKER主机>管理远程DOCKER主机</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/devops/>开发运维</a><ul><li><a href=/zh/posts/devops/github-actions/ title="GITHUB ACTIONS工作流">GITHUB ACTIONS工作流</a></li><li><a href=/zh/posts/devops/gitlab-ci-docker/ title="GITLAB CI自动部署容器应用">GITLAB CI自动部署容器应用</a></li><li><a href=/zh/posts/devops/k3s-terraform-ansible/ title=IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群>IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群</a></li><li><a href=/zh/posts/devops/tf-rover/ title=TF执行计划可视化>TF执行计划可视化</a></li><li><a href=/zh/posts/devops/tf-aws-lightsail/ title="TF管理AWS LIGHTSAIL实例">TF管理AWS LIGHTSAIL实例</a></li><li><a href=/zh/posts/devops/single-application-cicd/ title=一体化CI/CD平台>一体化CI/CD平台</a></li><li><a href=/zh/posts/devops/open-gitops/ title="解读OPEN GITOPS 1.0">解读OPEN GITOPS 1.0</a></li><li><a href=/zh/posts/devops/tf-cloud/ title="迁移本地项目到TF CLOUD">迁移本地项目到TF CLOUD</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/opentool/>开源工具</a><ul><li><a href=/zh/posts/opentool/diun-intro/ title=DIUN-容器镜像更新通知>DIUN-容器镜像更新通知</a></li><li><a href=/zh/posts/opentool/rclone-sync/ title=RCLOUD与云存储同步>RCLOUD与云存储同步</a></li><li><a href=/zh/posts/opentool/find-files/ title=文件系统查找工具>文件系统查找工具</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/programming/>编程</a><ul><li><a href=/zh/posts/programming/cocktail-improve/ title=改良鸡尾酒排序算法>改良鸡尾酒排序算法</a></li><li><a href=/zh/posts/programming/shell-debug/ title=调试Shell脚本错误>调试Shell脚本错误</a></li></ul></li><li><a href=/zh/posts/markdown-sample/ title=Markdown示例>Markdown示例</a></li><li><a href=/zh/posts/shortcodes/ title=短代码示例>短代码示例</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/zh/posts/windows/windows10-virtio-image/window10-virtio.webp)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/mengzyou_huc2c98b30dea57d312a21b09cfacc124e_6244_120x120_fit_q75_h2_box_2.webp alt="Author Image"><h5 class=author-name>You Mengzhe</h5><p>2021年6月8日星期二</p></div><div class=title><h1>加载virtio驱动的Windows10安装镜像</h1></div><div class=taxonomy-terms><ul style=padding-left:0><li class=rounded><a href=/zh/tags/virtualization/ class="btn, btn-sm">virtualization</a></li></ul></div><div class=post-content id=post-content><p>如今虚拟化已经非常流行，当我们使用Linux桌面环境时，可以通过安装<a href=https://libvirt.org/ target=_blank rel=noopener>libvirt</a>和<a href=https://www.qemu.org/ target=_blank rel=noopener>QEMU</a>直接使用基于内核的虚拟化（KVM）来创建虚拟机并安装其他类型的操作系统。在基于Linux的服务器上，也可以通过<a href=https://https://www.ovirt.org/ target=_blank rel=noopener>oVirt</a>或者<a href=https://www.proxmox.com/ target=_blank rel=noopener>PVE</a>等基于KVM的虚拟化方案来实现虚拟机环境。</p><p>当我们想通过官方iso系统镜像安装比较新的Windows（例如Windows 10，Windows Server 2019等），在进入到选择安装磁盘，会发现找不到创建的虚拟磁盘，如下图所示</p><p><img src=https://images.mengz.dev/posts/win10-no-driver.png alt=win10-no-driver></p><p>这是因为在官方的iso镜像中的Widnows未包含针对KVM的<a href=https://github.com/virtio-win/kvm-guest-drivers-windows target=_blank rel=noopener>virtio-win</a>驱动，因此我们可以基于Windows的iso镜像，加载virtio-win的相应驱动之后，重新创建一个包含了virtio-win驱动的iso镜像文件。</p><p>关于virtio-win的更多信息，可以参考 <a href=https://www.linux-kvm.org/page/WindowsGuestDrivers/Download_Drivers target=_blank rel=noopener>https://www.linux-kvm.org/page/WindowsGuestDrivers/Download_Drivers</a> 。</p><h2 id=前提条件>前提条件</h2><p>为了创建一个加载virtio-win驱动之后的iso镜像文件，我们需要以下准备：</p><ol><li>具有管理员权限的Windows 10工作系统并安装<a href="https://go.microsoft.com/fwlink/?linkid=2120254" target=_blank rel=noopener>Windows ADK</a></li><li>Windows 10的安装iso文件（这里以Windows 10作为例子）</li><li>virtio-win驱动的iso文件 (<a href=https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.196-1/virtio-win-0.1.196.iso target=_blank rel=noopener>https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.196-1/virtio-win-0.1.196.iso</a>)</li><li>UltraISO工具</li></ol><h2 id=准备工作>准备工作</h2><h3 id=创建工作目录>创建工作目录</h3><p>假设在你的Windows 10系统上有D盘，那我们在D盘创建相应的工作目录，以管理员权限打开PowerShell，并执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>PS D:\&gt; mkdir D:\mnt\windows_temp,D:\mnt\boot,D:\mnt\install,D:\virtio-win
</span></span></code></pre></div><h3 id=提取windows安装文件>提取Windows安装文件</h3><p>使用UltraISO工具打开windows 10的iso文件，并将所有文件提取到目录 *D:\mnt\windows_temp* 下</p><p><img src=https://images.mengz.dev/posts/ultraiso-extra-win10.png alt=ultraiso-extra-win10></p><p>然后给Windows的镜像文件授权读写</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>attrib</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>C:\mnt\windows_temp\sources\*.wim</span> /s
</span></span></code></pre></div><h3 id=提取virtio驱动文件>提取virtio驱动文件</h3><p>使用UltraISO打开下载的virtio-win的iso文件，同样提取到目录 *D:\virtio-win* 下，然后查看有哪些w10（针对windowns10）的驱动</p><p><img src=https://images.mengz.dev/posts/virtio-w10-drivers.png alt=virtio-w10-drivers></p><p>我们可以看到在 <strong>0.1.196</strong> 版本中，包含了以下w10（64位）的驱动，为了方便后面一条命令加载所有驱动，我们把这些驱动重新放到一个目录下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>cd</span> <span style=color:#a6e22e>virtio-win\</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>mkdir</span> <span style=color:#a6e22e>w10</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\Balloon\w10\amd64\</span> <span style=color:#a6e22e>.\w10\Balloon</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\NetKVM\w10\amd64\</span> <span style=color:#a6e22e>.\w10\NetKVM</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\pvpanic\w10\amd64\</span> <span style=color:#a6e22e>.\w10\pvpanic</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\qemufwcfg\w10\amd64\</span> <span style=color:#a6e22e>.\w10\qemufwcfg</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\qemupciserial\w10\amd64\</span> <span style=color:#a6e22e>.\w10\qemupciserial</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\qxldod\w10\amd64\</span> <span style=color:#a6e22e>.\w10\qxldod</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\sriov\w10\amd64\</span> <span style=color:#a6e22e>.\w10\sriov</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\viofs\w10\amd64\</span> <span style=color:#a6e22e>.\w10\viofs</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\viogpudo\w10\amd64\</span> <span style=color:#a6e22e>.\w10\viogpudo</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\vioinput\w10\amd64\</span> <span style=color:#a6e22e>.\w10\vioinput</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\viorng\w10\amd64\</span> <span style=color:#a6e22e>.\w10\viorng</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\vioscsi\w10\amd64\</span> <span style=color:#a6e22e>.\w10\vioscsi</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\vioserial\w10\amd64\</span> <span style=color:#a6e22e>.\w10\vioserial</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\virtio-win\</span>&gt; <span style=color:#a6e22e>cp</span> <span style=color:#a6e22e>-r</span> <span style=color:#a6e22e>.\viostor\w10\amd64\</span> <span style=color:#a6e22e>.\w10\viostor</span>
</span></span></code></pre></div><p>如果创建的是其他版本的Windows系统，例如Windows Server 2019，则提取对应目录（2k19/）下的驱动。</p><h2 id=加载virtio驱动>加载virtio驱动</h2><p>需要加载virtio驱动到Windows镜像文件 <strong>boot.wim</strong> 和 <strong>install.wim</strong> 。</p><h3 id=加载驱动到bootwim>加载驱动到boot.wim</h3><p>挂载提取出来的 <em>D:\mnt\windows_temp\sources\boot.wim</em> 文件到目录 *D:\mnt\boot* :</p><p>先获取镜像文件的索引</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>Get-WindowsImage</span> <span style=color:#a6e22e>-ImagePath</span> <span style=color:#a6e22e>D:\mnt\windows_temp\sources\boot.wim</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageIndex</span>       <span style=color:#a6e22e>:</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageName</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Microsoft</span> <span style=color:#a6e22e>Windows</span> <span style=color:#a6e22e>PE</span> <span style=color:#e6db74>(x64)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageDescription</span> <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Microsoft</span> <span style=color:#a6e22e>Windows</span> <span style=color:#a6e22e>PE</span> <span style=color:#e6db74>(x64)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageSize</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>1,657,563,910</span> <span style=color:#a6e22e>bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageIndex</span>       <span style=color:#a6e22e>:</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageName</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Microsoft</span> <span style=color:#a6e22e>Windows</span> <span style=color:#a6e22e>Setup</span> <span style=color:#e6db74>(x64)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageDescription</span> <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Microsoft</span> <span style=color:#a6e22e>Windows</span> <span style=color:#a6e22e>Setup</span> <span style=color:#e6db74>(x64)</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageSize</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>1,809,575,703</span> <span style=color:#a6e22e>bytes</span>
</span></span></code></pre></div><p>然后挂载索引2</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>Mount-WindowsImage</span> <span style=color:#a6e22e>-Path</span> <span style=color:#a6e22e>D:\mnt\boot\</span> <span style=color:#a6e22e>-ImagePath</span> <span style=color:#a6e22e>D:\mnt\windows_temp\sources\boot.wim</span> <span style=color:#a6e22e>-Index</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Path</span>          <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>D:\mnt\boot\</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Online</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>False</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartNeeded</span> <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>False</span>
</span></span></code></pre></div><p>接下来就是加载我们之前提取出来的驱动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>Add-WindowsDriver</span> <span style=color:#a6e22e>-Path</span> <span style=color:#a6e22e>D:\mnt\boot\</span> <span style=color:#a6e22e>-Driver</span> <span style=color:#a6e22e>D:\virtio-win\w10\</span> <span style=color:#a6e22e>-Recurse</span>
</span></span></code></pre></div><p>可以使用下面的命令来查看驱动是否已经加载进去</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>Get-WindowsDriver</span> <span style=color:#a6e22e>-Path</span> <span style=color:#a6e22e>D:\mnt\boot\</span>
</span></span></code></pre></div><p>确定加载成功后，卸载镜像挂载并保存</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>Dismount-WindowsImage</span> <span style=color:#a6e22e>-Path</span> <span style=color:#a6e22e>D:\mnt\boot\</span> <span style=color:#a6e22e>-Save</span>
</span></span></code></pre></div><h3 id=加载驱动到installwim>加载驱动到install.wim</h3><p>同样，首先查看 <strong>install.wim</strong> 镜像的索引（不同索引指定了同一iso文件里的版本）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>Get-WindowsImage</span> <span style=color:#a6e22e>-ImagePath</span> <span style=color:#a6e22e>D:\mnt\windows_temp\sources\install.wim</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageIndex</span>       <span style=color:#a6e22e>:</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageName</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>教育版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageDescription</span> <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>教育版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageSize</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>15,543,804,395</span> <span style=color:#a6e22e>bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageIndex</span>       <span style=color:#a6e22e>:</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageName</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>企业版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageDescription</span> <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>企业版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageSize</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>15,543,958,390</span> <span style=color:#a6e22e>bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageIndex</span>       <span style=color:#a6e22e>:</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageName</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>专业版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageDescription</span> <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>专业版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageSize</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>15,540,672,790</span> <span style=color:#a6e22e>bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageIndex</span>       <span style=color:#a6e22e>:</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageName</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>专业教育版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageDescription</span> <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>专业教育版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageSize</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>15,543,742,813</span> <span style=color:#a6e22e>bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageIndex</span>       <span style=color:#a6e22e>:</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageName</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>专业工作站版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageDescription</span> <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>Windows</span> <span style=color:#ae81ff>10</span> <span style=color:#a6e22e>专业工作站版</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ImageSize</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>15,543,773,604</span> <span style=color:#a6e22e>bytes</span>
</span></span></code></pre></div><p>挂载想要加载驱动的版本，例如专业版</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>Mount-WindowsImage</span> <span style=color:#a6e22e>-Path</span> <span style=color:#a6e22e>D:\mnt\install\</span> <span style=color:#a6e22e>-ImagePath</span> <span style=color:#a6e22e>D:\mnt\windows_temp\sources\install.wim</span> <span style=color:#a6e22e>-Index</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Path</span>          <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>D:\mnt\install\</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Online</span>        <span style=color:#a6e22e>:</span> <span style=color:#a6e22e>False</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>RestartNeeded</span> <span style=color:#a6e22e>：False</span>
</span></span></code></pre></div><p>然后加载驱动</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>Add-WindowsDriver</span> <span style=color:#a6e22e>-Path</span> <span style=color:#a6e22e>D:\mnt\install\</span> <span style=color:#a6e22e>-Driver</span> <span style=color:#a6e22e>D:\virtio-win\w10\</span> <span style=color:#a6e22e>-Recurse</span>
</span></span></code></pre></div><p>卸载保存</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>Dismount-WindowsImage</span> <span style=color:#a6e22e>-Path</span> <span style=color:#a6e22e>D:\mnt\install\</span> <span style=color:#a6e22e>-Save</span>
</span></span></code></pre></div><p>同理，可以继续挂载其他索引（版本），执行以上操作，加载驱动，然后保存。</p><h2 id=创建新的iso镜像文件>创建新的iso镜像文件</h2><p>这里我们使用Windows ADK带的 <strong>oscdimg</strong> 工具来创建ISO文件，安装完<a href="https://go.microsoft.com/fwlink/?linkid=2120254" target=_blank rel=noopener>Windows ADK</a>工具之后，进入目录 *C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Deployment Tools\amd64\Oscdimg*</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps data-lang=ps><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>D:\</span>&gt; <span style=color:#a6e22e>cd</span> <span style=color:#a6e22e>&#39;C:\Program</span> <span style=color:#a6e22e>Files</span> <span style=color:#e6db74>(x86)</span><span style=color:#a6e22e>\Windows</span> <span style=color:#a6e22e>Kits\10\Assessment</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Deployment</span> <span style=color:#a6e22e>Kit\Deployment</span> <span style=color:#a6e22e>Tools\amd64\Oscdimg&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PS</span> <span style=color:#a6e22e>C:\Program</span> <span style=color:#a6e22e>Files</span> <span style=color:#e6db74>(x86)</span><span style=color:#a6e22e>\Windows</span> <span style=color:#a6e22e>Kits\10\Assessment</span> <span style=color:#a6e22e>and</span> <span style=color:#a6e22e>Deployment</span> <span style=color:#a6e22e>Kit\Deployment</span> <span style=color:#a6e22e>Tools\amd64\Oscdimg</span>&gt; <span style=color:#a6e22e>.\oscdimg.exe</span> <span style=color:#a6e22e>-lcn_windows_10_virtio</span> <span style=color:#a6e22e>-m</span> <span style=color:#a6e22e>-u2</span> <span style=color:#a6e22e>-bD:\mnt\windows_temp\boot\etfsboot.com</span> <span style=color:#a6e22e>D:\mnt\windows_temp\</span> <span style=color:#a6e22e>D:\ISOFiles\cn_windows_10_virtio_x64.iso</span>
</span></span></code></pre></div><p>只想如上命令后，就会在目录 *D:\ISOFiles* 目录下创建出一个名为 <strong>cn_windows_10_virtio_x64.iso</strong> 的文件。</p><p>最后尝试使用新创建的iso文件来安装虚拟机系统，在选择选择磁盘驱动器时，我们就可以看到我们创建的虚拟磁盘了</p><p><img src=https://images.mengz.dev/posts/win10-with-driver.png alt=win10-with-driver></p><p>接下来就可以正常安装了。</p><h2 id=总结>总结</h2><p>本文以Windows 10的iso文件作为示例，演示了如何将virtio-win驱动加载进去，并且创建新的iso文件，使得在基于KVM的虚拟环境也可以顺利加载虚拟机磁盘进行Windows的安装。当然某些虚拟厂家也会直接提供相应的签名驱动，在安装过程中可以通过多增加一个虚拟CD驱动器来加载相应的驱动。</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn btn-sm facebook-btn" href="https://www.facebook.com/sharer.php?u=%2fzh%2fposts%2fwindows%2fwindows10-virtio-image%2f" target=_blank><i class="fab fa-facebook"></i></a>
<a class="btn btn-sm twitter-btn" href="https://twitter.com/share?url=%2fzh%2fposts%2fwindows%2fwindows10-virtio-image%2f&text=%e5%8a%a0%e8%bd%bdvirtio%e9%a9%b1%e5%8a%a8%e7%9a%84Windows10%e5%ae%89%e8%a3%85%e9%95%9c%e5%83%8f&via=Mengz%27s%20Space%20..." target=_blank><i class="fab fa-twitter"></i></a>
<a class="btn btn-sm linkedin-btn" href="https://www.linkedin.com/shareArticle?url=%2fzh%2fposts%2fwindows%2fwindows10-virtio-image%2f&title=%e5%8a%a0%e8%bd%bdvirtio%e9%a9%b1%e5%8a%a8%e7%9a%84Windows10%e5%ae%89%e8%a3%85%e9%95%9c%e5%83%8f" target=_blank><i class="fab fa-linkedin"></i></a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/zh/posts/windows/windows10-wsl2/ title=Windows10上安装WSL2 class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>Windows10上安装WSL2</div></a></div><div class="col-md-6 next-article"><a href=/zh/posts/container-tech/docker-live-restore/ title="DOCKER LIVERESTORE特性" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>DOCKER LIVERESTORE特性</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#前提条件>前提条件</a></li><li><a href=#准备工作>准备工作</a><ul><li><a href=#创建工作目录>创建工作目录</a></li><li><a href=#提取windows安装文件>提取Windows安装文件</a></li><li><a href=#提取virtio驱动文件>提取virtio驱动文件</a></li></ul></li><li><a href=#加载virtio驱动>加载virtio驱动</a><ul><li><a href=#加载驱动到bootwim>加载驱动到boot.wim</a></li><li><a href=#加载驱动到installwim>加载驱动到install.wim</a></li></ul></li><li><a href=#创建新的iso镜像文件>创建新的iso镜像文件</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/zh/#about>关于</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#skills>技能</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#experiences>工作经历</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#education>教育</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#recent-posts>近期文章</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#accomplishments>技能学习</a></li><li class=nav-item><a class=smooth-scroll href=https://live.mengz.dev/>LiveTerm</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:mengz.you@outlook.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>mengz.you@outlook.com</span></a></li><li><a href=https://github.com/mengzyou target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>mengzyou</span></a></li><li><a href=https://www.linkedin.com/in/mengzyou target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>You Mengzhe</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.3f98eac98ee0e5efd906fd54a896210d7d275efa5f73c9f8712612a554846688.js integrity="sha256-P5jqyY7g5e/ZBv1UqJYhDX0nXvpfc8n4cSYSpVSEZog=" defer></script>
<script src=https://storage.ko-fi.com/cdn/scripts/overlay-widget.js></script>
<script>kofiWidgetOverlay.draw("mengz",{type:"floating-chat","floating-chat.donateButton.text":"Buy me a book","floating-chat.donateButton.text-color":"#f9fafc","floating-chat.donateButton.background-color":"#248aaa"})</script></body></html>