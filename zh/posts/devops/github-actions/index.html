<!doctype html><html lang=zh><head><title>GITHUB ACTIONS工作流</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/application.fb9df7e952c9dccf496d00faec07de633aae460f909bbba4b5e0ad22f5887d73.css integrity="sha256-+5336VLJ3M9JbQD67AfeYzquRg+Qm7ukteCtIvWIfXM="><link rel=icon type=image/png href=/images/site/favicon_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png><meta property="og:title" content="GITHUB ACTIONS工作流"><meta property="og:description" content="介绍如何使用Github Actions创建CI/CD工作流"><meta property="og:type" content="article"><meta property="og:url" content="/zh/posts/devops/github-actions/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-05T17:31:54+08:00"><meta property="article:modified_time" content="2020-03-05T17:31:54+08:00"><meta name=description content="介绍如何使用Github Actions创建CI/CD工作流"><script src=https://cdn.counter.dev/script.js data-id=2905461c-37df-49f9-a4ca-0ea1ba64543a data-utcoffset=1></script></head><body class="type-posts kind-page" data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/zh/><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png alt=Logo>
Mengz's Space ...</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=menu-icon-center src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme"></a>
<a class="dropdown-item nav-link" href=# data-scheme=dark><img class=menu-icon-center src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a>
<a class="dropdown-item nav-link" href=# data-scheme=system><img class=menu-icon-center src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/zh/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/zh/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/k8s/>Kubernetes</a><ul><li><a href=/zh/posts/k8s/health-checks/ title=K8S健康检查最佳实践>K8S健康检查最佳实践</a></li><li><a href=/zh/posts/k8s/kubectl-plugins/ title=扩展你的KUBECTL功能>扩展你的KUBECTL功能</a></li><li><a href=/zh/posts/k8s/lightweight-k3s/ title=轻量级Kubernetes集群-K3S>轻量级Kubernetes集群-K3S</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/linux/>LINUX</a><ul><li><a href=/zh/posts/linux/bumlebee-nvidia/ title=BUMBLEBEE禁用NVIDIA显卡>BUMBLEBEE禁用NVIDIA显卡</a></li><li><a href=/zh/posts/linux/systemd-hostnamectl/ title=HOSTNAMECTL管理主机名>HOSTNAMECTL管理主机名</a></li><li><a href=/zh/posts/linux/make-undeletable/ title=LINUX上创建不可删除文件>LINUX上创建不可删除文件</a></li><li><a href=/zh/posts/linux/network-packets/ title=LINUX上统计网络接口数据包>LINUX上统计网络接口数据包</a></li><li><a href=/zh/posts/linux/opensuse-zypper/ title=OPENSUSE上的ZYPPER包管理器>OPENSUSE上的ZYPPER包管理器</a></li><li><a href=/zh/posts/linux/opensuse-cronjob/ title=OPENSUSE上的定时任务>OPENSUSE上的定时任务</a></li><li><a href=/zh/posts/linux/systemd-systemctl/ title=SYSTEMCTL管理系统服务>SYSTEMCTL管理系统服务</a></li><li><a href=/zh/posts/linux/systemd-timer/ title=SYSTEMD定时服务>SYSTEMD定时服务</a></li><li><a href=/zh/posts/linux/opensuse-upgrade/ title="升级OPENSUSE LEAP">升级OPENSUSE LEAP</a></li><li><a href=/zh/posts/linux/wireguard-vpn/ title=在LINUX上配置WIREGUARD>在LINUX上配置WIREGUARD</a></li><li><a href=/zh/posts/linux/ubuntu-old-kernel/ title=在UBUNTU上删除旧的内核>在UBUNTU上删除旧的内核</a></li><li><a href=/zh/posts/linux/what-hardware/ title=查看硬件信息>查看硬件信息</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/windows/>Windows</a><ul><li><a href=/zh/posts/windows/windows10-wsl2/ title=Windows10上安装WSL2>Windows10上安装WSL2</a></li><li><a href=/zh/posts/windows/windows10-virtio-image/ title=加载virtio驱动的Windows10安装镜像>加载virtio驱动的Windows10安装镜像</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/container-tech/>容器技术</a><ul><li><a href=/zh/posts/container-tech/docker-live-restore/ title="DOCKER LIVERESTORE特性">DOCKER LIVERESTORE特性</a></li><li><a href=/zh/posts/container-tech/docker-sbom/ title="DOCKER SBOM镜像物料清单">DOCKER SBOM镜像物料清单</a></li><li><a href=/zh/posts/container-tech/dockerfile-best/ title=DOCKERFILE构建最佳实践>DOCKERFILE构建最佳实践</a></li><li><a href=/zh/posts/container-tech/docker-intro/ title=DOCKER入门>DOCKER入门</a></li><li><a href=/zh/posts/container-tech/mariadb-docker/ title=DOCKER构建MariaDB>DOCKER构建MariaDB</a></li><li><a href=/zh/posts/container-tech/docker-container-app/ title=DOCKER构建容器化应用>DOCKER构建容器化应用</a></li><li><a href=/zh/posts/container-tech/docker-wechat/ title=DOCKER运行微信桌面客户端>DOCKER运行微信桌面客户端</a></li><li><a href=/zh/posts/container-tech/docker-desktop-windows/ title="WINDOWS上的DOCKER DESKTOP">WINDOWS上的DOCKER DESKTOP</a></li><li><a href=/zh/posts/container-tech/docker-compose-v2/ title="开始使用DOCKER COMPOSE V2">开始使用DOCKER COMPOSE V2</a></li><li><a href=/zh/posts/container-tech/smallest-web-container/ title=最小化静态WEB容器实践>最小化静态WEB容器实践</a></li><li><a href=/zh/posts/container-tech/docker-mqtt-broker/ title=本地环境运行MQTT容器>本地环境运行MQTT容器</a></li><li><a href=/zh/posts/container-tech/docker-context-remote/ title=管理远程DOCKER主机>管理远程DOCKER主机</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/zh/posts/devops/>开发运维</a><ul class=active><li><a class=active href=/zh/posts/devops/github-actions/ title="GITHUB ACTIONS工作流">GITHUB ACTIONS工作流</a></li><li><a href=/zh/posts/devops/gitlab-ci-docker/ title="GITLAB CI自动部署容器应用">GITLAB CI自动部署容器应用</a></li><li><a href=/zh/posts/devops/k3s-terraform-ansible/ title=IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群>IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群</a></li><li><a href=/zh/posts/devops/tf-rover/ title=TF执行计划可视化>TF执行计划可视化</a></li><li><a href=/zh/posts/devops/tf-aws-lightsail/ title="TF管理AWS LIGHTSAIL实例">TF管理AWS LIGHTSAIL实例</a></li><li><a href=/zh/posts/devops/single-application-cicd/ title=一体化CI/CD平台>一体化CI/CD平台</a></li><li><a href=/zh/posts/devops/open-gitops/ title="解读OPEN GITOPS 1.0">解读OPEN GITOPS 1.0</a></li><li><a href=/zh/posts/devops/tf-cloud/ title="迁移本地项目到TF CLOUD">迁移本地项目到TF CLOUD</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/opentool/>开源工具</a><ul><li><a href=/zh/posts/opentool/diun-intro/ title=DIUN-容器镜像更新通知>DIUN-容器镜像更新通知</a></li><li><a href=/zh/posts/opentool/rclone-sync/ title=RCLOUD与云存储同步>RCLOUD与云存储同步</a></li><li><a href=/zh/posts/opentool/find-files/ title=文件系统查找工具>文件系统查找工具</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/programming/>编程</a><ul><li><a href=/zh/posts/programming/cocktail-improve/ title=改良鸡尾酒排序算法>改良鸡尾酒排序算法</a></li><li><a href=/zh/posts/programming/shell-debug/ title=调试Shell脚本错误>调试Shell脚本错误</a></li></ul></li><li><a href=/zh/posts/markdown-sample/ title=Markdown示例>Markdown示例</a></li><li><a href=/zh/posts/shortcodes/ title=短代码示例>短代码示例</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/zh/posts/devops/github-actions/github-actions.png)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/mengz_hu7eb9b9c6ecaf6b9d36921f96f3e8114d_65269_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>You Mengzhe</h5><p>2020年3月5日星期四</p></div><div class=title><h1>GITHUB ACTIONS工作流</h1></div><div class=taxonomy-terms><ul style=padding-left:0><li class=rounded><a href=/zh/tags/github/ class="btn, btn-sm">github</a></li><li class=rounded><a href=/zh/tags/cicd/ class="btn, btn-sm">cicd</a></li></ul></div><div class=post-content id=post-content><p>这篇文章以一个简单的Nodejs应用为例，示例如何使用<a href=https://github.com/features/actions target=_blank rel=noopener>Github Actions</a>来自动构建，测试和部署一个应用．</p><h2 id=什么是github-actions>什么是Github Actions</h2><p>首先简单介绍下什么是Github Actions？　Github Actions是Github官方提供的一个与Github集成在一起的CI/CD工具，使用Github Actions可以非常容易地自动化你的所有软件工作流程，包括持续集成（CI）和持续发布（CD）．</p><p>不过要使用Github Actions，你需要将你的项目代码库放在Github上，然后为代码库配置相应的工作流（Workflows）．　　</p><p><img src=/images/devops/github-actions.png alt=Github-Actions></p><h3 id=actions-runner>Actions Runner</h3><p>使用Github Actions来执行工作流任务，还需要一个可执行的环境，Actions Runner就是提供这样的环境，Github Actions支持两种类型的Runner:</p><ul><li>Github-Hosted Runner : 由Github官方提供和维护的Runner服务器，不需要用户自己维护和更新，有支持Linnux，Windows，macOS环境的构建</li><li>Self-Hosted Runner : 用户自己使用本地机器，云服务器安装Actions应用，用户可以自定义硬件，软件等需求</li></ul><h3 id=actions>Actions</h3><p>在Github Actions中有一个Action的概念，Actions是一个独立的任务，你可以组合这些任务成为要完成一个工作的步骤.　　</p><p>在工作步骤中，你可以自己写执行命令组成Action，也可以直接使用Github社区提供的针对一个写公共任务的Actions，可以到<a href="https://github.com/marketplace?type=actions" target=_blank rel=noopener>Github市场</a>查找社区或者其他开发人员编写的Actions．　　</p><p>例如一个最常用的Action - <a href=https://github.com/marketplace/actions/checkout target=_blank rel=noopener>checkout</a>，可用来检出代码库：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>- <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span></code></pre></div><p>除了以上概念之外，Github Actions还有其他概念需要了解，具体可参考　(<a href=https://help.github.com/en/actions/getting-started-with-github-actions/overview target=_blank rel=noopener>https://help.github.com/en/actions/getting-started-with-github-actions/overview</a>)</p><h2 id=nodejs应用示例>Nodejs应用示例</h2><p>接下来，我们就那个简单的nodejs应用来看看如何使用Github Actions创建CI/CD的流程．</p><p>首先，你的项目代码库需要放在Github上，例如　https://github/mengzyou/hellonode/ ，访问你的代码库主页，然后点击 <code>Actions</code> 进入Actions页面．</p><p><img src=/images/devops/access-actions.png alt=Access-Actions></p><p>根据你的代码库的语言类型，Github推荐了一些Workflow的模板，这里我们将使用Nodejs的模板　　</p><p><img src=/images/devops/actions-nodejs-template.png alt=nodejs-template></p><p>直接点击 <code>Set up this workflow</code> 来应用这个模板，然后Github会直接打来Web编辑器来编辑这个模板文件</p><p><img src=/images/devops/actions-workflow-editor.png alt=nodjs-workflow-editor></p><p>你可以直接使用该文件，也可以修改，添加需要的Actions，完成之后可以点击　<code>Start commit</code> 按钮来提交Workflow文件，Github会自动为代码库创建目录　<code>.github/workflows/</code>，以及把该文件放在该目录下，例如　<code>.github/workflows/nodejs.yml</code> .　　</p><p>提交之后，Github Actions就会根据Workflow的内容开始运行相应的工作．</p><h3 id=创建一个执行测试ci工作流>创建一个执行测试CI工作流</h3><p>其实我们也可以直接编辑本地代码库，添加目录　<code>.github/workflows/｀，以及创建相应的Workflows配置文件，例如我们创建一个　</code>.github/workflows/nodejs.yml`　　</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Node.js CI</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container</span>: <span style=color:#ae81ff>node:12.16-alpine</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Checkout repository code</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Cache node modules</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/cache@v1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>cache-name</span>: <span style=color:#ae81ff>cache-node-modules</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>./node_modules</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>key</span>: <span style=color:#ae81ff>${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(&#39;**/package-lock.json&#39;) }}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>restore-keys</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ${{ runner.os }}-build-${{ env.cache-name }}-
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ${{ runner.os }}-build-
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            ${{ runner.os }}-</span>            
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install Dependencies</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm install</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Test</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm test</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>CI</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>我们就定义了一个Workflow，并命名为 <strong>Node.js CI</strong>，将在master分支发生push时执行．并且定义了一个名为　<strong>build</strong> 的工作（job），该工作将使用Github-Hosted Runner（ubuntu-latest，Github-Hosted Runner会虚拟化一个相应的操作系统环境），我们也会使用容器来执行相应的步骤，这里使用了Docker容器镜像<code>node:12.16-alpine</code>.　　</p><p><code>setps</code>定义将要执行的没有个步骤，可以给每个步骤命名，也可以直接调用相应的Actions，或者直接使用　<code>－run</code> 来执行命令．　　
上面的步骤中，有使用　<code>actions/checkout@v2</code> 来拉去代码库，也有使用　<code>actions/cache@v1</code> 来创建使用缓存（使用缓存可加速工作流的执行），然后使用直接行命令　<code>npm install</code> 和　<code>npm test</code>　的步骤．　　</p><p>当我们编写好之后，创建一个提交，然后Push到Github上master分支，就会出发一次定义的CI流程，如下图所示</p><p><img src=/images/devops/actions-nodejs-test.png alt=nodejs-build-job></p><p>我们可以通过Github代码库的<code>Actions</code>页面查看Workflow执行的状态和结果，也可以查看执行的日志．</p><p>在上面的示例中，我们的工作流里只有一个Job，就是测试代码，我们可以添加更多的Job来只想其他任务．例如打包我们的应用，部署我们的应用．</p><p>下面我们就添加更多工作来完成我们的整个CI/CD工作流．</p><h3 id=添加一个工作打包应用的docker镜像>添加一个工作打包应用的Docker镜像</h3><p>我们编辑　<code>.github/workflows/nodejs.yml</code> 文件，添加以下内容　　</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>  <span style=color:#f92672>package</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>needs</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Checkout repository code</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v2</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Build &amp; Push container image</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>mr-smithers-excellent/docker-build-push@v2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mengzyou/hellonode</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>tag</span>: <span style=color:#ae81ff>latest</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>registry</span>: <span style=color:#ae81ff>docker.io</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>username</span>: <span style=color:#ae81ff>${{ secrets.DOCKERHUB_USERNAME }}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>password</span>: <span style=color:#ae81ff>${{ secrets.DOCKERHUB_TOKEN }}</span>
</span></span></code></pre></div><p>我们添加两一个job - package，这个job将运行在Github-Hosted Runner（ubuntu-latest）上，<code>needs</code> 表示该job需要 <code>build</code>　job成功执行完成之后才执行．<br>包括了两个步骤，拉取代码库，然后是使用 <code>mr-smithers-excellent/docker-build-push@v2</code> Action来执行容器镜像的构建和推送．　　
这个Action中，我们还使用到了Github Actions的Secrets，Secrets可以配置一些敏感的变量，到Github代码库设置的Secrets进行配置</p><p><img src=/images/devops/github-actions-secrets.png alt=actions-secrets></p><p>这里我们配置了推送Docker镜像到Dokcer Hub需要的用户名和访问凭证. 对于<a href=https://hub.docker.com/ target=_blank rel=noopener>Docker Hub</a>，推荐使用<a href=https://docs.docker.com/docker-hub/access-tokens/ target=_blank rel=noopener>Docker Hub Access Token</a>作为访问密码．</p><p>我们将Workflow提交到master分支后，在地一个<code>build</code>工作之后，就发触发这个job，打包镜像并推送到Docker Hub.　　</p><h3 id=添加一个工作来自动部署>添加一个工作来自动部署</h3><p>接下来，为了完成整个CI/CD的演示，我们再添加一个job，名为　<code>deploy</code>．　对于这个job的执行，我们需要使用一个Self-Hosted的Runner．</p><p>访问代码库的Github界面，点击<code>Settings</code>，然后点击左侧边栏的<code>Actions</code>，再点击`Add runner｀按钮</p><p><img src=/images/devops/github-actions-add-runner.png alt=add-runner></p><p>按照弹出来的指导，在需要部署应用的服务器上安装 <code>action-runner</code>，这里我们选择的是在一个Linux上安装，成功启动runner应用之后，会连接Github服务，在Gihub的<code>Self-hosted runners</code>下能看到添加的runner的状态，这样添加的一个Self-hosted runner会具有标签[&lsquo;self-hosted&rsquo;,&rsquo;linux&rsquo;,&lsquo;x86&rsquo;]，这些标签将会用于job选择合适runner来执行．</p><p>添加了Self-hosted　Runner之后，我们就可以在Workflow里添加相应的job了　　</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>  <span style=color:#f92672>deploy</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: [<span style=color:#ae81ff>self-hosted,linux]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>needs</span>: <span style=color:#ae81ff>package</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>env</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>CONTAINER_IMAGE</span>: <span style=color:#ae81ff>mengzyou/hellonode</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>CONTAINER_NAME</span>: <span style=color:#ae81ff>webapps_hellonode</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Docker pull image</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>docker image pull $CONTAINER_IMAGE</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Docker stop container</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>docker container stop $CONTAINER_NAME</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Docker remove container</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>if</span>: <span style=color:#ae81ff>always()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>docker container rm -f $CONTAINER_NAME</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Docker run container</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>if</span>: <span style=color:#ae81ff>always()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>docker container run --name $CONTAINER_NAME -d -p 8000:3000 $CONTAINER_IMAGE</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Prune images</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>if</span>: <span style=color:#ae81ff>always()</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>docker image prune -f   </span> <span style=color:#75715e># remove the dangling images</span>
</span></span></code></pre></div><p>这里，我们将 <code>runs-on</code>　设置为　[self-hosted,linux]　来选择运行的Runner服务器，然后该job需要　<code>package</code> job 成功完成之后才会执行．　　
我们还配置了两个Job（．job.env）范围内的变量来使用我们的容器镜像和名字．然后包含了以下执行步骤：　　</p><ol><li>从Docker Hub拉取上一个Job构建出来的容器镜像</li><li>停止运行的容器</li><li>删除之前的应用容器</li><li>使用新的镜像运行一个新的应用容器</li><li>清理旧的容器镜像</li></ol><p>提交代码，Push到master分支，这样一个包含３个Jobs的Workflow就会自动执行，如果在任何一个Job中只想错误，都会停止后续的Jobs，并且给出反馈．</p><p><img src=/images/devops/github-actions-cicd-workflow.png alt=ci-ci-workflow></p><h2 id=总结>总结</h2><p>上面通过为一个简单的nodejs应用添加了Github Actions来完成了一个构建，打包，部署的CI/CD流程．通过使用Github Actions，可以很容易地为我们放在Github上的项创建CI/CD流程，管理软件开发的生命周期（SDLC）．　　</p><p>Gihhub Actions类似于<a href=https://gitlab.com/ target=_blank rel=noopener>Gitlab</a>的<a href=https://docs.gitlab.com/ee/ci/ target=_blank rel=noopener>Gitlab-CI</a>，以及［Jinkens］(<a href=https://jenkins.io/zh/ target=_blank rel=noopener>https://jenkins.io/zh/</a>)，还有很多第三方的CI/CD服务．</p><p>Github Actions是Github原生支持的，因此对于代码库管理在Github上的组织和用户，更容易使用．</p><blockquote><p>参考</p><ul><li><a href=https://help.github.com/en/actions target=_blank rel=noopener>https://help.github.com/en/actions</a></li></ul></blockquote></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn btn-sm facebook-btn" href="https://www.facebook.com/sharer.php?u=%2fzh%2fposts%2fdevops%2fgithub-actions%2f" target=_blank><i class="fab fa-facebook"></i></a>
<a class="btn btn-sm twitter-btn" href="https://twitter.com/share?url=%2fzh%2fposts%2fdevops%2fgithub-actions%2f&text=GITHUB%20ACTIONS%e5%b7%a5%e4%bd%9c%e6%b5%81&via=Mengz%27s%20Space%20..." target=_blank><i class="fab fa-twitter"></i></a>
<a class="btn btn-sm linkedin-btn" href="https://www.linkedin.com/shareArticle?url=%2fzh%2fposts%2fdevops%2fgithub-actions%2f&title=GITHUB%20ACTIONS%e5%b7%a5%e4%bd%9c%e6%b5%81" target=_blank><i class="fab fa-linkedin"></i></a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/zh/posts/container-tech/docker-context-remote/ title=管理远程DOCKER主机 class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>管理远程DOCKER主机</div></a></div><div class="col-md-6 next-article"><a href=/zh/posts/devops/gitlab-ci-docker/ title="GITLAB CI自动部署容器应用" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>GITLAB CI自动部署容器应用</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#什么是github-actions>什么是Github Actions</a><ul><li><a href=#actions-runner>Actions Runner</a></li><li><a href=#actions>Actions</a></li></ul></li><li><a href=#nodejs应用示例>Nodejs应用示例</a><ul><li><a href=#创建一个执行测试ci工作流>创建一个执行测试CI工作流</a></li><li><a href=#添加一个工作打包应用的docker镜像>添加一个工作打包应用的Docker镜像</a></li><li><a href=#添加一个工作来自动部署>添加一个工作来自动部署</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/zh/#about>关于</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#skills>技能</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#experiences>工作经历</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#education>教育</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#recent-posts>近期文章</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#accomplishments>技能学习</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:mengz.you@outlook.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>mengz.you@outlook.com</span></a></li><li><a href=https://github.com/mengzyou target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>mengzyou</span></a></li><li><a href=https://www.linkedin.com/in/mengzyou target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>You Mengzhe</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.d06ddacd4080231ac954a78539ea5f5a1921ebbd740618450ead7a0e8466dfda.js integrity="sha256-0G3azUCAIxrJVKeFOepfWhkh6710BhhFDq16DoRm39o=" defer></script></body></html>