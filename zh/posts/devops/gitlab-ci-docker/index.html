<!doctype html><html lang=zh><head><title>GITLAB CI自动部署容器应用</title>
<meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><link rel=stylesheet href=/application.fb9df7e952c9dccf496d00faec07de633aae460f909bbba4b5e0ad22f5887d73.css integrity="sha256-+5336VLJ3M9JbQD67AfeYzquRg+Qm7ukteCtIvWIfXM="><link rel=icon type=image/png href=/images/site/favicon_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png><meta property="og:url" content="/zh/posts/devops/gitlab-ci-docker/"><meta property="og:site_name" content="Mengz's Space ..."><meta property="og:title" content="GITLAB CI自动部署容器应用"><meta property="og:description" content="容器 Docker 越来越受开发者和运维人员的喜爱，更是作为实践 DevOps 的一个中要工具。同时 Gitlab 提供了免费的代码管理服务，其 gitlab-ci 更是提供了强大的自动化 CI/CD 流程功能。
本文以一个静态站点的示例来说明如何使用 gitlab-ci 和 docker 进行容器镜像的构建，以及如何将镜像自动化部署到目标服务器上。
编写Dockerfile 首先在代码库中增加 Dockerfile ，用于描述如何构建应用的容器镜像。以下是一个基于 Hugo 的静态站点应用的示例：
FROM mengzyou/hugo:latest as builder COPY . /app/ RUN hugo FROM nginx:1.16-alpine RUN set -x \ &amp;amp;&amp;amp; rm -f /etc/nginx/conf.d/default.conf \ &amp;amp;&amp;amp; mkdir -p /usr/share/nginx/html COPY --from=builder /app/nginx-default.conf /etc/nginx/conf.d/default.conf COPY --from=builder /app/public/ /usr/share/nginx/html 其实非常简单，使用了多阶段构建，以 mengzyou/hugo 作为构建镜像，然后将生成的静态文件拷贝到 nginx 镜像中，最终生成静态站点的镜像。
配置Gitlab-ci构建容器镜像 该阶段，在项目根目录添加 .gitlab-ci.yml 文件，示例内容如下：
variables: DOCKER_DRIVER: overlay2 CI_REGISTRY_IMAGE: ${CI_REGISTRY}/mengzyou/app before_script: - echo $CI_JOB_NAME - echo $CI_PROJECT_DIR stages: - build build:docker: stage: build variables: DOCKER_HOST: tcp://docker:2375 image: docker:stable services: - docker:dind script: - echo &amp;#34;Building image - $CI_REGISTRY_IMAGE:latest&amp;#34; - echo &amp;#34;$CI_REGISTRY_PASSWORD&amp;#34; | docker login -u &amp;#34;$CI_REGISTRY_USER&amp;#34; --password-stdin $CI_REGISTRY - docker image build --force-rm --no-cache -t $CI_REGISTRY_IMAGE:latest ."><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-07-30T09:57:36+08:00"><meta property="article:modified_time" content="2019-07-30T09:57:36+08:00"><meta property="article:tag" content="Gitlab"><meta property="article:tag" content="Cicd"><meta property="article:tag" content="Docker"><meta name=description content="GITLAB CI自动部署容器应用"><script src=https://cdn.counter.dev/script.js data-id=2905461c-37df-49f9-a4ca-0ea1ba64543a data-utcoffset=1></script></head><body class="type-posts kind-page" data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<span class=navbar-toggler-icon></span>
</button>
<a class=navbar-brand href=/zh/><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png alt=Logo>
Mengz's Space ...</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=menu-icon-center src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=dark><img class=menu-icon-center src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme">
</a><a class="dropdown-item nav-link" href=# data-scheme=system><img class=menu-icon-center src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/zh/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/zh/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/k8s/>Kubernetes</a><ul><li><a href=/zh/posts/k8s/health-checks/ title=K8S健康检查最佳实践>K8S健康检查最佳实践</a></li><li><a href=/zh/posts/k8s/kubectl-plugins/ title=扩展你的KUBECTL功能>扩展你的KUBECTL功能</a></li><li><a href=/zh/posts/k8s/lightweight-k3s/ title=轻量级Kubernetes集群-K3S>轻量级Kubernetes集群-K3S</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/linux/>LINUX</a><ul><li><a href=/zh/posts/linux/bumlebee-nvidia/ title=BUMBLEBEE禁用NVIDIA显卡>BUMBLEBEE禁用NVIDIA显卡</a></li><li><a href=/zh/posts/linux/systemd-hostnamectl/ title=HOSTNAMECTL管理主机名>HOSTNAMECTL管理主机名</a></li><li><a href=/zh/posts/linux/make-undeletable/ title=LINUX上创建不可删除文件>LINUX上创建不可删除文件</a></li><li><a href=/zh/posts/linux/network-packets/ title=LINUX上统计网络接口数据包>LINUX上统计网络接口数据包</a></li><li><a href=/zh/posts/linux/opensuse-zypper/ title=OPENSUSE上的ZYPPER包管理器>OPENSUSE上的ZYPPER包管理器</a></li><li><a href=/zh/posts/linux/opensuse-cronjob/ title=OPENSUSE上的定时任务>OPENSUSE上的定时任务</a></li><li><a href=/zh/posts/linux/systemd-systemctl/ title=SYSTEMCTL管理系统服务>SYSTEMCTL管理系统服务</a></li><li><a href=/zh/posts/linux/systemd-timer/ title=SYSTEMD定时服务>SYSTEMD定时服务</a></li><li><a href=/zh/posts/linux/opensuse-upgrade/ title="升级OPENSUSE LEAP">升级OPENSUSE LEAP</a></li><li><a href=/zh/posts/linux/wireguard-vpn/ title=在LINUX上配置WIREGUARD>在LINUX上配置WIREGUARD</a></li><li><a href=/zh/posts/linux/ubuntu-old-kernel/ title=在UBUNTU上删除旧的内核>在UBUNTU上删除旧的内核</a></li><li><a href=/zh/posts/linux/what-hardware/ title=查看硬件信息>查看硬件信息</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/windows/>Windows</a><ul><li><a href=/zh/posts/windows/windows10-wsl2/ title=Windows10上安装WSL2>Windows10上安装WSL2</a></li><li><a href=/zh/posts/windows/windows10-virtio-image/ title=加载virtio驱动的Windows10安装镜像>加载virtio驱动的Windows10安装镜像</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/container-tech/>容器技术</a><ul><li><a href=/zh/posts/container-tech/docker-live-restore/ title="DOCKER LIVERESTORE特性">DOCKER LIVERESTORE特性</a></li><li><a href=/zh/posts/container-tech/docker-sbom/ title="DOCKER SBOM镜像物料清单">DOCKER SBOM镜像物料清单</a></li><li><a href=/zh/posts/container-tech/dockerfile-best/ title=DOCKERFILE构建最佳实践>DOCKERFILE构建最佳实践</a></li><li><a href=/zh/posts/container-tech/docker-intro/ title=DOCKER入门>DOCKER入门</a></li><li><a href=/zh/posts/container-tech/mariadb-docker/ title=DOCKER构建MariaDB>DOCKER构建MariaDB</a></li><li><a href=/zh/posts/container-tech/docker-container-app/ title=DOCKER构建容器化应用>DOCKER构建容器化应用</a></li><li><a href=/zh/posts/container-tech/docker-wechat/ title=DOCKER运行微信桌面客户端>DOCKER运行微信桌面客户端</a></li><li><a href=/zh/posts/container-tech/docker-desktop-windows/ title="WINDOWS上的DOCKER DESKTOP">WINDOWS上的DOCKER DESKTOP</a></li><li><a href=/zh/posts/container-tech/docker-compose-v2/ title="开始使用DOCKER COMPOSE V2">开始使用DOCKER COMPOSE V2</a></li><li><a href=/zh/posts/container-tech/smallest-web-container/ title=最小化静态WEB容器实践>最小化静态WEB容器实践</a></li><li><a href=/zh/posts/container-tech/docker-mqtt-broker/ title=本地环境运行MQTT容器>本地环境运行MQTT容器</a></li><li><a href=/zh/posts/container-tech/docker-context-remote/ title=管理远程DOCKER主机>管理远程DOCKER主机</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/zh/posts/devops/>开发运维</a><ul class=active><li><a href=/zh/posts/devops/github-actions/ title="GITHUB ACTIONS工作流">GITHUB ACTIONS工作流</a></li><li><a class=active href=/zh/posts/devops/gitlab-ci-docker/ title="GITLAB CI自动部署容器应用">GITLAB CI自动部署容器应用</a></li><li><a href=/zh/posts/devops/k3s-terraform-ansible/ title=IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群>IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群</a></li><li><a href=/zh/posts/devops/tf-rover/ title=TF执行计划可视化>TF执行计划可视化</a></li><li><a href=/zh/posts/devops/tf-aws-lightsail/ title="TF管理AWS LIGHTSAIL实例">TF管理AWS LIGHTSAIL实例</a></li><li><a href=/zh/posts/devops/single-application-cicd/ title=一体化CI/CD平台>一体化CI/CD平台</a></li><li><a href=/zh/posts/devops/open-gitops/ title="解读OPEN GITOPS 1.0">解读OPEN GITOPS 1.0</a></li><li><a href=/zh/posts/devops/tf-cloud/ title="迁移本地项目到TF CLOUD">迁移本地项目到TF CLOUD</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/opentool/>开源工具</a><ul><li><a href=/zh/posts/opentool/diun-intro/ title=DIUN-容器镜像更新通知>DIUN-容器镜像更新通知</a></li><li><a href=/zh/posts/opentool/rclone-sync/ title=RCLOUD与云存储同步>RCLOUD与云存储同步</a></li><li><a href=/zh/posts/opentool/find-files/ title=文件系统查找工具>文件系统查找工具</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/programming/>编程</a><ul><li><a href=/zh/posts/programming/cocktail-improve/ title=改良鸡尾酒排序算法>改良鸡尾酒排序算法</a></li><li><a href=/zh/posts/programming/shell-debug/ title=调试Shell脚本错误>调试Shell脚本错误</a></li></ul></li><li><a href=/zh/posts/markdown-sample/ title=Markdown示例>Markdown示例</a></li><li><a href=/zh/posts/shortcodes/ title=短代码示例>短代码示例</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/mengzyou_huc2c98b30dea57d312a21b09cfacc124e_6244_120x120_fit_q75_h2_box_2.webp alt="Author Image"><h5 class=author-name>You Mengzhe</h5><p>2019年7月30日星期二</p></div><div class=title><h1>GITLAB CI自动部署容器应用</h1></div><div class=taxonomy-terms><ul style=padding-left:0><li class=rounded><a href=/zh/tags/gitlab/ class="btn, btn-sm">gitlab</a></li><li class=rounded><a href=/zh/tags/cicd/ class="btn, btn-sm">cicd</a></li><li class=rounded><a href=/zh/tags/docker/ class="btn, btn-sm">docker</a></li></ul></div><div class=post-content id=post-content><p>容器 <a href=https://www.docker.com target=_blank rel=noopener>Docker</a> 越来越受开发者和运维人员的喜爱，更是作为实践 <a href=https://zh.wikipedia.org/zh-hans/DevOps target=_blank rel=noopener>DevOps</a> 的一个中要工具。同时 <a href=https://gitlab.com/ target=_blank rel=noopener>Gitlab</a> 提供了免费的代码管理服务，其 <a href=https://about.gitlab.com/product/continuous-integration/ target=_blank rel=noopener>gitlab-ci</a> 更是提供了强大的自动化 CI/CD 流程功能。</p><p>本文以一个静态站点的示例来说明如何使用 gitlab-ci 和 docker 进行容器镜像的构建，以及如何将镜像自动化部署到目标服务器上。</p><h3 id=编写dockerfile>编写Dockerfile</h3><p>首先在代码库中增加 <a href=https://docs.docker.com/engine/reference/builder/ target=_blank rel=noopener>Dockerfile</a> ，用于描述如何构建应用的容器镜像。以下是一个基于 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 的静态站点应用的示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mengzyou/hugo:latest as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . /app/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> hugo<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> nginx:1.16-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> set -x <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>&amp;&amp;</span> rm -f /etc/nginx/conf.d/default.conf <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>&amp;&amp;</span> mkdir -p /usr/share/nginx/html<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/nginx-default.conf /etc/nginx/conf.d/default.conf<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder /app/public/ /usr/share/nginx/html<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>其实非常简单，使用了多阶段构建，以 <a href=https://hub.docker.com/r/mengzyou/hugo target=_blank rel=noopener>mengzyou/hugo</a> 作为构建镜像，然后将生成的静态文件拷贝到 <a href=https://hub.docker.com/_/nginx target=_blank rel=noopener>nginx</a> 镜像中，最终生成静态站点的镜像。</p><h3 id=配置gitlab-ci构建容器镜像>配置Gitlab-ci构建容器镜像</h3><p>该阶段，在项目根目录添加 <code>.gitlab-ci.yml</code> 文件，示例内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>DOCKER_DRIVER</span>: <span style=color:#ae81ff>overlay2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>CI_REGISTRY_IMAGE</span>: <span style=color:#ae81ff>${CI_REGISTRY}/mengzyou/app</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>before_script</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>echo $CI_JOB_NAME</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>echo $CI_PROJECT_DIR</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>stages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>build:docker</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>DOCKER_HOST</span>: <span style=color:#ae81ff>tcp://docker:2375</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>docker:stable</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker:dind</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;Building image - $CI_REGISTRY_IMAGE:latest&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;$CI_REGISTRY_PASSWORD&#34; | docker login -u &#34;$CI_REGISTRY_USER&#34; --password-stdin $CI_REGISTRY</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker image build --force-rm --no-cache -t $CI_REGISTRY_IMAGE:latest .</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker image push $CI_REGISTRY_IMAGE:latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master</span>
</span></span></code></pre></div><p>其中有几个变量是需要在代码库的 Gitlab 上进行配置，如下图所示：</p><p><img alt=gitlab-ci-setting src=https://images.mengz.dev/posts/gitlab-cicd-variables.png></p><p>因为直接是用了 Gitlab 提供的容器镜像服务，构建完成的镜像需要推送到该镜像仓库服务，所以需要配置相应的仓库地址，用户名和登录密码：</p><ul><li>CI_REGISTRY : 仓库地址，如 registry.gitlab.com</li><li>CI_REGISTRY_USER : Gitlab 的访问用户名</li><li>CI_REGISTRY_PASSWORD : Gitlab 的访问密码</li></ul><p>这样在推送镜像之前，需要进行一次登录操作。更多关于如何是用 Gitlab 容器镜像仓库可参考 <a href=https://docs.gitlab.com/ee/user/project/container_registry.html target=_blank rel=noopener>https://docs.gitlab.com/ee/user/project/container_registry.html</a> 。</p><p>该 pipeline 工作使用了 <a href=https://docs.gitlab.com/runner/ target=_blank rel=noopener>Gitlab Runner</a> 的 docker 执行器，如果是自己安装和注册 gitlab-runner ，请参考其文档。这里直接是用了 Gitlab.com 分享的 Runner 。</p><h3 id=安装用于部署的gitlab-runner>安装用于部署的gitlab-runner</h3><p>为了在目标服务器上使用 gitlab-ci 进行自动部署（运行容器），需要在目标服务器上安装和注册 gitlab-runner 。由于目标服务器上运行容器，因此应该首先安装好 Docker 环境，同时 gitlab-runner 也直接是用容器运行（当然也可以直接本地运行，具体可以查看 gitlab-runner 的文档）。</p><h4 id=安装注册runner>安装注册Runner</h4><p>可以使用 <a href=https://docs.docker.com/compose/ target=_blank rel=noopener>docker-compose</a> 来部署 gitlab-runner 容器，在目标服务器上的 <code>~/gitalb/</code> 目录下编写如下 <code>docker-compose.yml</code> 文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;2.4&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>runner</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>gitlab/gitlab-runner:alpine-v11.11.0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>gitlab_runner</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>always</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>network_mode</span>: <span style=color:#ae81ff>bridge</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config/:/etc/gitlab-runner/</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/run/docker.sock:/var/run/docker.sock</span>
</span></span></code></pre></div><p>创建目录 <code>config</code> 用于保存 runner 的配置:</p><p><code>mkdir config</code></p><p>然后启动 runner 容器：</p><p><code>docker-compose up -d runner</code></p><p>注册 runner 之前需要在 Gitlab 项目的 CI/CD 配置中（设置 > CI/CD > Runner）查看注册 URL 和令牌，如下图所示：</p><p><img alt=gitalb-runner-setting src=https://images.mengz.dev/posts/gitlab-runner-setting.png></p><p>接下来，运行一下命令进行 runner 的注册:</p><pre tabindex=0><code>docker-compose exec runner gitlab-runner register \
  --url https://gitlab.com/ \
  --registration-token $REGISTRATION_TOKEN \
  --executor docker \
  --description &#34;app-deployment-runner&#34; \
  --tag-list &#34;deploy,docker&#34; \
  --docker-image &#34;mengzyou/docker:19.03&#34; \
  --docker-volumes /var/run/docker.sock:/var/run/docker.sock
</code></pre><p><strong>注意</strong> : 上面的 $REGISTRATION_TOKEN 需要替换成真实的令牌值。</p><p>上面的命令注册了一个默认使用 <a href=https://hub.docker.com/r/mengzyou/docker target=_blank rel=noopener>mengzyou/docker</a> 镜像运行容器的执行器，同时挂载了 <code>/var/run/docker.sock</code>，因为默认执行容器里的 docker 将房屋主机上的 docker 服务。</p><h4 id=配置gitlab-ci进行自动部署>配置Gitlab-ci进行自动部署</h4><p>在 <code>.gitlab-ci.yml</code> 中增加部署的工作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>stages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>deoploy:docker</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;Deploy try_app - $CI_REGISTRY_IMAGE:latest&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;$CI_REGISTRY_PASSWORD&#34; | docker login -u &#34;$CI_REGISTRY_USER&#34; --password-stdin $CI_REGISTRY</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker rm -f try_app || true</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker image pull $CI_REGISTRY_IMAGE:latest</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker container run --name try_app -p 80:80 -d $CI_REGISTRY_IMAGE:latest</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker</span>
</span></span></code></pre></div><p>当然，也可以写部署脚本来执行部署的步骤，也可以使用 docker-compose 通过 docker-compose.yml 文件来执行，例如：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>deoploy:docker</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;Deploy ${CD_COMPOSE_PROJECT}_app - $CI_REGISTRY_IMAGE:latest&#34;</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;$CI_REGISTRY_PASSWORD&#34; | docker login -u &#34;$CI_REGISTRY_USER&#34; --password-stdin $CI_REGISTRY</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker image pull $CI_REGISTRY_IMAGE:latest</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>mkdir -p /tmp/${CD_COMPOSE_PROJECT} &amp;&amp; cp ${CI_PROJECT_DIR}/docker-compose.prod.yml /tmp/${CD_COMPOSE_PROJECT}/docker-compose.yml</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>cd /tmp/${CD_COMPOSE_PROJECT} &amp;&amp; docker-compose up -d myblog</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>master</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tags</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>docker</span>
</span></span></code></pre></div><p>其中可以定义 CD_COMPOSE_PROJECT 变量来指定 docker-compose 的项目名，相应的在代码根目录增加 <code>docker-compose.prod.yml</code> 文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#39;2.4&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>web</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>app</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;registry.gitlab.com/mengzyou/app:latest&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>web</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>mem_limit</span>: <span style=color:#ae81ff>256M</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.docker.network=web&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.backend=app&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.frontend.rule=Host:app.mengz.me;PathPrefix:/&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.frontend.redirect.entryPoint=https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.frontend.redirect.permanent=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.port=80&#34;</span>
</span></span></code></pre></div><p>上面的 <code>docker-composle</code> 文件还定义了 traefik 相关的参数，这要求在目标服务器上已经运行了相应的 traefik 服务作为 Web 代理。</p><p>完成以上步骤之后，每次推送 master 分支，都会触发相应的 gitlab CI/CD pipeline 来执行每个阶段的 CI/CD 工作，如下图：</p><p><img alt=gitlab-pipeline src=https://images.mengz.dev/posts/gitlab-pipeline.png></p><h3 id=总结>总结</h3><p>以上仅仅进行了一个简单应用的 CI/CD 示例，主要演示了如何使用 gitlab-ci 和 docker 来进行 CI/CD 流程。</p><p>对于不同的项目，如何构建？如何部署，情况都可能不一样，需要根据不同的场景来编写 <code>.gitlab-ci.yml</code> 文件，需要进一步阅读相应的<a href=https://about.gitlab.com/product/continuous-integration/ target=_blank rel=noopener>文档</a> 。</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn btn-sm facebook-btn" href="https://www.facebook.com/sharer.php?u=%2fzh%2fposts%2fdevops%2fgitlab-ci-docker%2f" target=_blank><i class="fab fa-facebook"></i>
</a><a class="btn btn-sm twitter-btn" href="https://twitter.com/share?url=%2fzh%2fposts%2fdevops%2fgitlab-ci-docker%2f&text=GITLAB%20CI%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2%e5%ae%b9%e5%99%a8%e5%ba%94%e7%94%a8&via=Mengz%27s%20Space%20..." target=_blank><i class="fab fa-twitter"></i>
</a><a class="btn btn-sm linkedin-btn" href="https://www.linkedin.com/shareArticle?url=%2fzh%2fposts%2fdevops%2fgitlab-ci-docker%2f&title=GITLAB%20CI%e8%87%aa%e5%8a%a8%e9%83%a8%e7%bd%b2%e5%ae%b9%e5%99%a8%e5%ba%94%e7%94%a8" target=_blank><i class="fab fa-linkedin"></i></a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/zh/posts/devops/github-actions/ title="GITHUB ACTIONS工作流" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>GITHUB ACTIONS工作流</div></a></div><div class="col-md-6 next-article"><a href=/zh/posts/devops/k3s-terraform-ansible/ title=IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群 class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><ul><li><a href=#编写dockerfile>编写Dockerfile</a></li><li><a href=#配置gitlab-ci构建容器镜像>配置Gitlab-ci构建容器镜像</a></li><li><a href=#安装用于部署的gitlab-runner>安装用于部署的gitlab-runner</a><ul><li><a href=#安装注册runner>安装注册Runner</a></li><li><a href=#配置gitlab-ci进行自动部署>配置Gitlab-ci进行自动部署</a></li></ul></li><li><a href=#总结>总结</a></li></ul></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/zh/#about>关于</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#skills>技能</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#experiences>工作经历</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#education>教育</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#recent-posts>近期文章</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#accomplishments>技能学习</a></li><li class=nav-item><a class=smooth-scroll href=https://live.mengz.dev/>LiveTerm</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:mengz.you@outlook.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>mengz.you@outlook.com</span></a></li><li><a href=https://github.com/mengzyou target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>mengzyou</span></a></li><li><a href=https://www.linkedin.com/in/mengzyou target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>You Mengzhe</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2024 - Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.74035eba644bbae33efea73e1508acb9c99d04231c848dda7fa8ce5dd16fff9e.js integrity="sha256-dANeumRLuuM+/qc+FQisucmdBCMchI3af6jOXdFv/54=" defer></script><script src=https://storage.ko-fi.com/cdn/scripts/overlay-widget.js></script><script>kofiWidgetOverlay.draw("mengz",{type:"floating-chat","floating-chat.donateButton.text":"Buy me a book","floating-chat.donateButton.text-color":"#f9fafc","floating-chat.donateButton.background-color":"#248aaa"})</script></body></html>