<!doctype html><html lang=zh><head><title>DOCKERFILE构建最佳实践</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/application.fb9df7e952c9dccf496d00faec07de633aae460f909bbba4b5e0ad22f5887d73.css integrity="sha256-+5336VLJ3M9JbQD67AfeYzquRg+Qm7ukteCtIvWIfXM="><link rel=icon type=image/png href=/images/site/favicon_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png><meta property="og:title" content="DOCKERFILE构建最佳实践"><meta property="og:description" content="在进行应用容器化的实践中，我们可以使用多种方式来创建容器镜像，而使用Dockerfile是我们最常用的方式。 而且在实现CI/CD Pipeline的过程中，使用Dockerfile来构建应用容器也是必须的。
本文不具体介绍Dockerfile的指令和写法，仅仅是在实践中积累的一些写好一个Dockerfile的小提示，体现在一下几个方面：
减少构建时间 减小镜像大小 镜像可维护性 重复构建一致性 安全性 减小构建时间 首先来看看下面这个Dockerfile
FROM ubuntu:18.04 COPY . /app RUN apt-get update RUN apt-get -y install ssh vim openjdk-8-jdk CMD [“java”,”-jar”,”/app/target/app.jar”] 要减小构建的时间，那我们可以例如Docker构建的缓存特性，尽量保留不经常改变的层，而在Dockerfile的指令中， COPY和RUN都会产生新的层，而且缓存的有效是与命令的顺序有关系的。
在上面的Dockerfile中，COPY . /app在RUN apt-get ...之前，而COPY是经常改变的部分，所以每次构建都会到导致RUN apt-get ...缓存失效。
Tip-1 : 合理利用缓存，而执行命令的顺序是会影响缓存的可用性的。
要减小构建时间，另一方面是应该仅仅COPY需要的东西，对于上面这个Dockerfile的目的，应该仅仅需要COPY Java应用的jar文件。
Tip-2 : 构建过程中仅仅COPY需要的东西。
上面的Dockerfile对apt-get命令分别使用了两个RUN指令，会生成两个不同的层。
Tip-3 : 尽量合并最终镜像的层数。
还有对于这个示例，我们最终是想要一个JRE环境来运行Java应用，因此可以选择一个jre的镜像来作为基础镜像，这样不用花时间再去安装jdk。
Tip-4 : 选择合适的基础镜像
这样我们可以把Dockerfile写成：
FROM ubuntu:18.04 RUN apt-get update \ && apt-get y install ssh vim openjdk-8-jdk COPY target/app.jar /app CMD [“java”,”-jar”,”/app/app."><meta property="og:type" content="article"><meta property="og:url" content="/zh/posts/container-tech/dockerfile-best/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-15T16:36:58+08:00"><meta property="article:modified_time" content="2020-07-15T16:36:58+08:00"><meta name=description content="DOCKERFILE构建最佳实践"><script src=https://cdn.counter.dev/script.js data-id=2905461c-37df-49f9-a4ca-0ea1ba64543a data-utcoffset=1></script></head><body class="type-posts kind-page" data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/zh/><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png alt=Logo>
Mengz's Space ...</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=menu-icon-center src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme"></a>
<a class="dropdown-item nav-link" href=# data-scheme=dark><img class=menu-icon-center src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a>
<a class="dropdown-item nav-link" href=# data-scheme=system><img class=menu-icon-center src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/zh/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/zh/posts/ data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/k8s/>Kubernetes</a><ul><li><a href=/zh/posts/k8s/health-checks/ title=K8S健康检查最佳实践>K8S健康检查最佳实践</a></li><li><a href=/zh/posts/k8s/kubectl-plugins/ title=扩展你的KUBECTL功能>扩展你的KUBECTL功能</a></li><li><a href=/zh/posts/k8s/lightweight-k3s/ title=轻量级Kubernetes集群-K3S>轻量级Kubernetes集群-K3S</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/linux/>LINUX</a><ul><li><a href=/zh/posts/linux/bumlebee-nvidia/ title=BUMBLEBEE禁用NVIDIA显卡>BUMBLEBEE禁用NVIDIA显卡</a></li><li><a href=/zh/posts/linux/systemd-hostnamectl/ title=HOSTNAMECTL管理主机名>HOSTNAMECTL管理主机名</a></li><li><a href=/zh/posts/linux/make-undeletable/ title=LINUX上创建不可删除文件>LINUX上创建不可删除文件</a></li><li><a href=/zh/posts/linux/network-packets/ title=LINUX上统计网络接口数据包>LINUX上统计网络接口数据包</a></li><li><a href=/zh/posts/linux/opensuse-zypper/ title=OPENSUSE上的ZYPPER包管理器>OPENSUSE上的ZYPPER包管理器</a></li><li><a href=/zh/posts/linux/opensuse-cronjob/ title=OPENSUSE上的定时任务>OPENSUSE上的定时任务</a></li><li><a href=/zh/posts/linux/systemd-systemctl/ title=SYSTEMCTL管理系统服务>SYSTEMCTL管理系统服务</a></li><li><a href=/zh/posts/linux/systemd-timer/ title=SYSTEMD定时服务>SYSTEMD定时服务</a></li><li><a href=/zh/posts/linux/opensuse-upgrade/ title="升级OPENSUSE LEAP">升级OPENSUSE LEAP</a></li><li><a href=/zh/posts/linux/wireguard-vpn/ title=在LINUX上配置WIREGUARD>在LINUX上配置WIREGUARD</a></li><li><a href=/zh/posts/linux/ubuntu-old-kernel/ title=在UBUNTU上删除旧的内核>在UBUNTU上删除旧的内核</a></li><li><a href=/zh/posts/linux/what-hardware/ title=查看硬件信息>查看硬件信息</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/windows/>Windows</a><ul><li><a href=/zh/posts/windows/windows10-wsl2/ title=Windows10上安装WSL2>Windows10上安装WSL2</a></li><li><a href=/zh/posts/windows/windows10-virtio-image/ title=加载virtio驱动的Windows10安装镜像>加载virtio驱动的Windows10安装镜像</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/zh/posts/container-tech/>容器技术</a><ul class=active><li><a href=/zh/posts/container-tech/docker-live-restore/ title="DOCKER LIVERESTORE特性">DOCKER LIVERESTORE特性</a></li><li><a href=/zh/posts/container-tech/docker-sbom/ title="DOCKER SBOM镜像物料清单">DOCKER SBOM镜像物料清单</a></li><li><a class=active href=/zh/posts/container-tech/dockerfile-best/ title=DOCKERFILE构建最佳实践>DOCKERFILE构建最佳实践</a></li><li><a href=/zh/posts/container-tech/docker-intro/ title=DOCKER入门>DOCKER入门</a></li><li><a href=/zh/posts/container-tech/mariadb-docker/ title=DOCKER构建MariaDB>DOCKER构建MariaDB</a></li><li><a href=/zh/posts/container-tech/docker-container-app/ title=DOCKER构建容器化应用>DOCKER构建容器化应用</a></li><li><a href=/zh/posts/container-tech/docker-wechat/ title=DOCKER运行微信桌面客户端>DOCKER运行微信桌面客户端</a></li><li><a href=/zh/posts/container-tech/docker-desktop-windows/ title="WINDOWS上的DOCKER DESKTOP">WINDOWS上的DOCKER DESKTOP</a></li><li><a href=/zh/posts/container-tech/docker-compose-v2/ title="开始使用DOCKER COMPOSE V2">开始使用DOCKER COMPOSE V2</a></li><li><a href=/zh/posts/container-tech/smallest-web-container/ title=最小化静态WEB容器实践>最小化静态WEB容器实践</a></li><li><a href=/zh/posts/container-tech/docker-mqtt-broker/ title=本地环境运行MQTT容器>本地环境运行MQTT容器</a></li><li><a href=/zh/posts/container-tech/docker-context-remote/ title=管理远程DOCKER主机>管理远程DOCKER主机</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/devops/>开发运维</a><ul><li><a href=/zh/posts/devops/github-actions/ title="GITHUB ACTIONS工作流">GITHUB ACTIONS工作流</a></li><li><a href=/zh/posts/devops/gitlab-ci-docker/ title="GITLAB CI自动部署容器应用">GITLAB CI自动部署容器应用</a></li><li><a href=/zh/posts/devops/k3s-terraform-ansible/ title=IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群>IaC示例-TERRAFORM&amp;ANSIBLE创建K3S集群</a></li><li><a href=/zh/posts/devops/tf-rover/ title=TF执行计划可视化>TF执行计划可视化</a></li><li><a href=/zh/posts/devops/tf-aws-lightsail/ title="TF管理AWS LIGHTSAIL实例">TF管理AWS LIGHTSAIL实例</a></li><li><a href=/zh/posts/devops/single-application-cicd/ title=一体化CI/CD平台>一体化CI/CD平台</a></li><li><a href=/zh/posts/devops/open-gitops/ title="解读OPEN GITOPS 1.0">解读OPEN GITOPS 1.0</a></li><li><a href=/zh/posts/devops/tf-cloud/ title="迁移本地项目到TF CLOUD">迁移本地项目到TF CLOUD</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/opentool/>开源工具</a><ul><li><a href=/zh/posts/opentool/diun-intro/ title=DIUN-容器镜像更新通知>DIUN-容器镜像更新通知</a></li><li><a href=/zh/posts/opentool/rclone-sync/ title=RCLOUD与云存储同步>RCLOUD与云存储同步</a></li><li><a href=/zh/posts/opentool/find-files/ title=文件系统查找工具>文件系统查找工具</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/zh/posts/programming/>编程</a><ul><li><a href=/zh/posts/programming/cocktail-improve/ title=改良鸡尾酒排序算法>改良鸡尾酒排序算法</a></li><li><a href=/zh/posts/programming/shell-debug/ title=调试Shell脚本错误>调试Shell脚本错误</a></li></ul></li><li><a href=/zh/posts/markdown-sample/ title=Markdown示例>Markdown示例</a></li><li><a href=/zh/posts/shortcodes/ title=短代码示例>短代码示例</a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/zh/posts/container-tech/dockerfile-best/docker-bp.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/author/mengzyou_hu94ee2a0121294b6b0424034f13ce004a_66548_120x120_fit_box_3.png alt="Author Image"><h5 class=author-name>You Mengzhe</h5><p>2020年7月15日星期三</p></div><div class=title><h1>DOCKERFILE构建最佳实践</h1></div><div class=taxonomy-terms><ul style=padding-left:0><li class=rounded><a href=/zh/tags/docker/ class="btn, btn-sm">docker</a></li></ul></div><div class=post-content id=post-content><p>在进行应用容器化的实践中，我们可以使用多种方式来创建容器镜像，而使用<a href=https://docs.docker.com/engine/reference/builder/ target=_blank rel=noopener>Dockerfile</a>是我们最常用的方式。
而且在实现CI/CD Pipeline的过程中，使用Dockerfile来构建应用容器也是必须的。</p><p>本文不具体介绍Dockerfile的指令和写法，仅仅是在实践中积累的一些写好一个Dockerfile的小提示，体现在一下几个方面：</p><ul><li>减少构建时间</li><li>减小镜像大小</li><li>镜像可维护性</li><li>重复构建一致性</li><li>安全性</li></ul><h2 id=减小构建时间>减小构建时间</h2><p>首先来看看下面这个Dockerfile</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ubuntu:18.04</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get -y install ssh vim openjdk-8-jdk<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#960050;background-color:#1e0010>“java”</span>,<span style=color:#960050;background-color:#1e0010>”-jar”</span>,<span style=color:#960050;background-color:#1e0010>”/app/target/app.jar”</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>要减小构建的时间，那我们可以例如Docker构建的缓存特性，尽量保留不经常改变的层，而在Dockerfile的指令中， <code>COPY</code>和<code>RUN</code>都会产生新的层，而且缓存的有效是与命令的顺序有关系的。<br>在上面的Dockerfile中，<code>COPY . /app</code>在<code>RUN apt-get ...</code>之前，而COPY是经常改变的部分，所以每次构建都会到导致<code>RUN apt-get ...</code>缓存失效。</p><p><strong>Tip-1</strong> : 合理利用缓存，而执行命令的顺序是会影响缓存的可用性的。</p><p>要减小构建时间，另一方面是应该仅仅COPY需要的东西，对于上面这个Dockerfile的目的，应该仅仅需要COPY Java应用的jar文件。</p><p><strong>Tip-2</strong> : 构建过程中仅仅COPY需要的东西。</p><p>上面的Dockerfile对apt-get命令分别使用了两个RUN指令，会生成两个不同的层。</p><p><strong>Tip-3</strong> : 尽量合并最终镜像的层数。</p><p>还有对于这个示例，我们最终是想要一个JRE环境来运行Java应用，因此可以选择一个jre的镜像来作为基础镜像，这样不用花时间再去安装jdk。</p><p><strong>Tip-4</strong> : 选择合适的基础镜像</p><p>这样我们可以把Dockerfile写成：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ubuntu:18.04</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get y install ssh vim openjdk-8-jdk<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> target/app.jar /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#960050;background-color:#1e0010>“java”</span>,<span style=color:#960050;background-color:#1e0010>”-jar”</span>,<span style=color:#960050;background-color:#1e0010>”/app/app.jar”</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=减小镜像大小>减小镜像大小</h2><p>进一步，我们如何尽量减小最终应用镜像的大小，来加速我们的CI构建，以及减小镜像在网络上传输的效率。<br>在上例中，<code>ssh, vim</code>应该都是不必要的软件包，它们会咱用镜像的空间。</p><p><strong>Tip-5</strong> : 移除不必要的软件包安装（包括一些debug工具）。</p><p>其次，类似apt-get之类的系统包管理工具会产生缓存数据，我们也应该清除。</p><p><strong>Tip-6</strong> : 在使用系统包管理工具安装软件包后清理缓存数据。</p><p>另外我们应该使用Docker提供的多阶段构建特性来减小最终的镜像大小，我们在后面介绍。</p><p>我们进一步改进Dockerfile：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ubuntu:18.04</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>&amp;&amp;</span> apt-get y install –no-install-recommends openjdk-8-jdk <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> target/app.jar /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#960050;background-color:#1e0010>“java”</span>,<span style=color:#960050;background-color:#1e0010>”-jar”</span>,<span style=color:#960050;background-color:#1e0010>”/app/app.jar”</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=镜像的可维护性>镜像的可维护性</h2><p>我们看看上面的Dockerfile，使用了一个<code>ubuntu</code>的镜像来安装jdk包，而在安装jdk包的不同时间点，可能会导致不同的版本，这样就导致了镜像的不易维护。</p><p><strong>Tip-7</strong> : 尽可能使用应用（语言）运行时的官方基础镜像，并指定Tag版本</p><p>一般来说，官方会维护一些变种镜像来提供多样性，例如基于 alpine的，还有 -slim 精简版本的，其次对于像Java应用，最终我们需要的应该只是JRE，因此应该选择jre的镜像，这样既保证了可维护性，同时也可以减小镜像的大小。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> openjdk:8-jre-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> target/app.jar /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#960050;background-color:#1e0010>“java”</span>,<span style=color:#960050;background-color:#1e0010>”-jar”</span>,<span style=color:#960050;background-color:#1e0010>”/app/app.jar”</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=重复构建一致性>重复构建一致性</h2><p>我们应该保障我们的镜像构建在任何时候，以及任何构建服务器上是一致的，但是我们看上面的Dockerfile，是将jar文件COPY到容器中，但是这个jar文件是在什么环境构建的呢？</p><p><strong>Tip-8</strong> : 在一致的环境中从源代码构建</p><p>同样，Docker的多阶段构建提供了最好的解决方案，将源码编译构建放到构建阶段，将最终生成的软件包COPY放到运行是阶段。</p><p><strong>Tip-9</strong> : 使用多阶段构建</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> maven:3.6-jdk-11 AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> pom.xml .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mvn -e -B dependency:resolve<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> src ./src<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mvn -e -B package<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> openjdk:11-jre-slim</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> –from<span style=color:#f92672>=</span>builder /app/target/app.jar /<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#960050;background-color:#1e0010>“java”</span>,<span style=color:#960050;background-color:#1e0010>”-jar”</span>,<span style=color:#960050;background-color:#1e0010>”/app.jar”</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>例如上面的Dockerfile，我们使用了<code>maven</code>的镜像来构建代码，使用<code>openjdk:jre</code>的镜像来运行。</p><h2 id=安全性>安全性</h2><p>最后我们来看看安全性，如何使我们的应用容器更加安全。首先，容器里包含的软件包越少，那可能的漏洞就会越少，所以这也是 <strong>Tip-5</strong> 所强调的。</p><p><strong>Tip-10</strong> : 使用非root用户运行容器应用进程</p><p>其次，我们应该使用非root用户来运行我们的应用，默认情况下容器都是使用root用户来执行，我们可以使用以下两种方法来使用非root用户来运行。</p><ol><li>使用<code>USER</code>指令，记得在使用<code>USER</code>指令前创建相应的用户</li><li>在<code>CMD</code>或者<code>ENTRYPOINT</code>中使用<code>su-exec</code> , <code>gosu</code>等工具来启动应用</li></ol><p>我推荐使用第二种方法，因为第一种方式，在启动容器后进入容器会默认使用非root用户，这样不便于安装某些调试工具来执行调试（当然也可以通过配置sudo）。<br>而第二种方式需要安装<code>su-exec</code>等工具，我建议自己基于官方的基础镜像维护一些自己的运行时基础镜像，这样避免在每次构建应用镜像的时候都进行一次安装。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> gradle:6.4-jdk11 as builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /code</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> gradle assemble<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mengzyou/openjdk:11-jre-alpine</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> APP_HOME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/opt/app&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>APP_USER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;appuser&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>JAR_OPTS<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;--spring.profiles.active=prod&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> addgroup <span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  adduser -D -h <span style=color:#e6db74>${</span>APP_HOME<span style=color:#e6db74>}</span> -S -G <span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span> <span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder --chown<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span> /code/build/libs/*.jar <span style=color:#e6db74>${</span>APP_HOME<span style=color:#e6db74>}</span>/app.jar<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080/tcp</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> ${APP_HOME}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> su-exec app java <span style=color:#e6db74>${</span>JAVA_OPTS<span style=color:#e6db74>}</span> -jar <span style=color:#e6db74>${</span>APP_HOME<span style=color:#e6db74>}</span>/app.jar <span style=color:#e6db74>${</span>JAR_OPTS<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># CMD [“su-exec”,”appuser”,”sh -c”,”java -jar /opt/app/app.jar&#34;]</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>在来一个golang的示例</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> golang:1.14-alpine AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apk add --no-cache git <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    mkdir -p $GOPATH/src/app <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>WORKDIR $GOPATH/src/app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . $GOPATH/src/app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> go mod tidy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> go build -o /go/bin/app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> mengzyou/alpine:3.12</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> APP_HOME<span style=color:#f92672>=</span>/opt/app <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    APP_USER<span style=color:#f92672>=</span>appuser<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> addgroup <span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  adduser -D -h <span style=color:#e6db74>${</span>APP_HOME<span style=color:#e6db74>}</span> -S -G <span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span> <span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder --chown<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span>:<span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span> /go/bin/app <span style=color:#e6db74>${</span>APP_HOME<span style=color:#e6db74>}</span>/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080/tcp</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> ${APP_HOME}</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> su-exec <span style=color:#e6db74>${</span>APP_USER<span style=color:#e6db74>}</span> <span style=color:#e6db74>${</span>APP_HOME<span style=color:#e6db74>}</span>/app<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=总结>总结</h2><p>这里仅仅是在Dockerfile实践中的一些提示，要写好Dockerfile，还有很多方面需要注意的地方，可参考Docker官方的<a href=https://docs.docker.com/develop/develop-images/dockerfile_best-practices/ target=_blank rel=noopener>Best practices for writing Dockerfiles</a>。</p></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"><strong>Share on:</strong>
<a class="btn btn-sm facebook-btn" href="https://www.facebook.com/sharer.php?u=%2fzh%2fposts%2fcontainer-tech%2fdockerfile-best%2f" target=_blank><i class="fab fa-facebook"></i></a>
<a class="btn btn-sm twitter-btn" href="https://twitter.com/share?url=%2fzh%2fposts%2fcontainer-tech%2fdockerfile-best%2f&text=DOCKERFILE%e6%9e%84%e5%bb%ba%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5&via=Mengz%27s%20Space%20..." target=_blank><i class="fab fa-twitter"></i></a>
<a class="btn btn-sm linkedin-btn" href="https://www.linkedin.com/shareArticle?url=%2fzh%2fposts%2fcontainer-tech%2fdockerfile-best%2f&title=DOCKERFILE%e6%9e%84%e5%bb%ba%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" target=_blank><i class="fab fa-linkedin"></i></a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/zh/posts/container-tech/docker-sbom/ title="DOCKER SBOM镜像物料清单" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>DOCKER SBOM镜像物料清单</div></a></div><div class="col-md-6 next-article"><a href=/zh/posts/container-tech/docker-intro/ title=DOCKER入门 class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>DOCKER入门</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#减小构建时间>减小构建时间</a></li><li><a href=#减小镜像大小>减小镜像大小</a></li><li><a href=#镜像的可维护性>镜像的可维护性</a></li><li><a href=#重复构建一致性>重复构建一致性</a></li><li><a href=#安全性>安全性</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/zh/#about>关于</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#skills>技能</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#experiences>工作经历</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#education>教育</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#recent-posts>近期文章</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#accomplishments>技能学习</a></li><li class=nav-item><a class=smooth-scroll href=https://live.mengz.dev/>LiveTerm</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:mengz.you@outlook.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>mengz.you@outlook.com</span></a></li><li><a href=https://github.com/mengzyou target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>mengzyou</span></a></li><li><a href=https://www.linkedin.com/in/mengzyou target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>You Mengzhe</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.d06ddacd4080231ac954a78539ea5f5a1921ebbd740618450ead7a0e8466dfda.js integrity="sha256-0G3azUCAIxrJVKeFOepfWhkh6710BhhFDq16DoRm39o=" defer></script></body></html>