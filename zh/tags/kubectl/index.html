<!doctype html><html lang=zh><head><title>kubectl</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/application.fb9df7e952c9dccf496d00faec07de633aae460f909bbba4b5e0ad22f5887d73.css integrity="sha256-+5336VLJ3M9JbQD67AfeYzquRg+Qm7ukteCtIvWIfXM="><link rel=icon type=image/png href=/images/site/favicon_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png><meta property="og:title" content="kubectl"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="/zh/tags/kubectl/"><script src=https://cdn.counter.dev/script.js data-id=2905461c-37df-49f9-a4ca-0ea1ba64543a data-utcoffset=1></script></head><body class="type-tags kind-term" data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/zh/><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png alt=Logo>
Mengz's Space ...</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=themeSelector role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false><img id=navbar-theme-icon-svg src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a><div id=themeMenu class="dropdown-menu dropdown-menu-icons-only" aria-labelledby=themeSelector><a class="dropdown-item nav-link" href=# data-scheme=light><img class=menu-icon-center src=/icons/sun-svgrepo-com.svg width=20 alt="Light Theme"></a>
<a class="dropdown-item nav-link" href=# data-scheme=dark><img class=menu-icon-center src=/icons/moon-svgrepo-com.svg width=20 alt="Dark Theme"></a>
<a class="dropdown-item nav-link" href=# data-scheme=system><img class=menu-icon-center src=/icons/computer-svgrepo-com.svg width=20 alt="System Theme"></a></div></li></ul></div></div><img src=/images/site/main-logo_hu69a4da50b288ac7c5f97b1e1012a418e_8650_42x0_resize_box_3.png class=d-none id=main-logo alt=Logo>
<img src=/images/site/inverted-logo_hu3d2f89ed4395f8e4a11f46415bebb510_10034_42x0_resize_box_3.png class=d-none id=inverted-logo alt="Inverted Logo"></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/zh/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/zh/tags data-filter=all>Tags</a></li><div class="subtree taxonomy-terms"><li><a class=taxonomy-term href=/zh/tags/algorithm/ data-taxonomy-term=algorithm><span class=taxonomy-label>algorithm</span></a></li><li><a class=taxonomy-term href=/zh/tags/ansible/ data-taxonomy-term=ansible><span class=taxonomy-label>ansible</span></a></li><li><a class=taxonomy-term href=/zh/tags/aws/ data-taxonomy-term=aws><span class=taxonomy-label>aws</span></a></li><li><a class=taxonomy-term href=/zh/tags/cicd/ data-taxonomy-term=cicd><span class=taxonomy-label>cicd</span></a></li><li><a class=taxonomy-term href=/zh/tags/cloud/ data-taxonomy-term=cloud><span class=taxonomy-label>cloud</span></a></li><li><a class=taxonomy-term href=/zh/tags/cluster/ data-taxonomy-term=cluster><span class=taxonomy-label>cluster</span></a></li><li><a class=taxonomy-term href=/zh/tags/cncf/ data-taxonomy-term=cncf><span class=taxonomy-label>cncf</span></a></li><li><a class=taxonomy-term href=/zh/tags/command/ data-taxonomy-term=command><span class=taxonomy-label>command</span></a></li><li><a class=taxonomy-term href=/zh/tags/compose/ data-taxonomy-term=compose><span class=taxonomy-label>compose</span></a></li><li><a class=taxonomy-term href=/zh/tags/contianer/ data-taxonomy-term=contianer><span class=taxonomy-label>contianer</span></a></li><li><a class=taxonomy-term href=/zh/tags/cotainer/ data-taxonomy-term=cotainer><span class=taxonomy-label>cotainer</span></a></li><li><a class=taxonomy-term href=/zh/tags/cpp/ data-taxonomy-term=cpp><span class=taxonomy-label>cpp</span></a></li><li><a class=taxonomy-term href=/zh/tags/crontab/ data-taxonomy-term=crontab><span class=taxonomy-label>crontab</span></a></li><li><a class=taxonomy-term href=/zh/tags/debug/ data-taxonomy-term=debug><span class=taxonomy-label>debug</span></a></li><li><a class=taxonomy-term href=/zh/tags/docker/ data-taxonomy-term=docker><span class=taxonomy-label>docker</span></a></li><li><a class=taxonomy-term href=/zh/tags/find/ data-taxonomy-term=find><span class=taxonomy-label>find</span></a></li><li><a class=taxonomy-term href=/zh/tags/github/ data-taxonomy-term=github><span class=taxonomy-label>github</span></a></li><li><a class=taxonomy-term href=/zh/tags/gitlab/ data-taxonomy-term=gitlab><span class=taxonomy-label>gitlab</span></a></li><li><a class=taxonomy-term href=/zh/tags/gitops/ data-taxonomy-term=gitops><span class=taxonomy-label>gitops</span></a></li><li><a class=taxonomy-term href=/zh/tags/hardware/ data-taxonomy-term=hardware><span class=taxonomy-label>hardware</span></a></li><li><a class=taxonomy-term href=/zh/tags/hostname/ data-taxonomy-term=hostname><span class=taxonomy-label>hostname</span></a></li><li><a class=taxonomy-term href=/zh/tags/k3s/ data-taxonomy-term=k3s><span class=taxonomy-label>k3s</span></a></li><li><a class=taxonomy-term href=/zh/tags/kernel/ data-taxonomy-term=kernel><span class=taxonomy-label>kernel</span></a></li><li><a class="taxonomy-term active" href=/zh/tags/kubectl/ data-taxonomy-term=kubectl><span class=taxonomy-label>kubectl</span></a></li><li><a class=taxonomy-term href=/zh/tags/kubernetes/ data-taxonomy-term=kubernetes><span class=taxonomy-label>kubernetes</span></a></li><li><a class=taxonomy-term href=/zh/tags/linux/ data-taxonomy-term=linux><span class=taxonomy-label>linux</span></a></li><li><a class=taxonomy-term href=/zh/tags/mariadb/ data-taxonomy-term=mariadb><span class=taxonomy-label>mariadb</span></a></li><li><a class=taxonomy-term href=/zh/tags/mqtt/ data-taxonomy-term=mqtt><span class=taxonomy-label>mqtt</span></a></li><li><a class=taxonomy-term href=/zh/tags/network/ data-taxonomy-term=network><span class=taxonomy-label>network</span></a></li><li><a class=taxonomy-term href=/zh/tags/nvidia/ data-taxonomy-term=nvidia><span class=taxonomy-label>nvidia</span></a></li><li><a class=taxonomy-term href=/zh/tags/opensuse/ data-taxonomy-term=opensuse><span class=taxonomy-label>opensuse</span></a></li><li><a class=taxonomy-term href=/zh/tags/rclone/ data-taxonomy-term=rclone><span class=taxonomy-label>rclone</span></a></li><li><a class=taxonomy-term href=/zh/tags/sbom/ data-taxonomy-term=sbom><span class=taxonomy-label>sbom</span></a></li><li><a class=taxonomy-term href=/zh/tags/security/ data-taxonomy-term=security><span class=taxonomy-label>security</span></a></li><li><a class=taxonomy-term href=/zh/tags/shell/ data-taxonomy-term=shell><span class=taxonomy-label>shell</span></a></li><li><a class=taxonomy-term href=/zh/tags/slack/ data-taxonomy-term=slack><span class=taxonomy-label>slack</span></a></li><li><a class=taxonomy-term href=/zh/tags/systemd/ data-taxonomy-term=systemd><span class=taxonomy-label>systemd</span></a></li><li><a class=taxonomy-term href=/zh/tags/terraform/ data-taxonomy-term=terraform><span class=taxonomy-label>terraform</span></a></li><li><a class=taxonomy-term href=/zh/tags/terrafrom/ data-taxonomy-term=terrafrom><span class=taxonomy-label>terrafrom</span></a></li><li><a class=taxonomy-term href=/zh/tags/ubuntu/ data-taxonomy-term=ubuntu><span class=taxonomy-label>ubuntu</span></a></li><li><a class=taxonomy-term href=/zh/tags/virtualization/ data-taxonomy-term=virtualization><span class=taxonomy-label>virtualization</span></a></li><li><a class=taxonomy-term href=/zh/tags/vpn/ data-taxonomy-term=vpn><span class=taxonomy-label>vpn</span></a></li><li><a class=taxonomy-term href=/zh/tags/web/ data-taxonomy-term=web><span class=taxonomy-label>web</span></a></li><li><a class=taxonomy-term href=/zh/tags/wechat/ data-taxonomy-term=wechat><span class=taxonomy-label>wechat</span></a></li><li><a class=taxonomy-term href=/zh/tags/windows/ data-taxonomy-term=windows><span class=taxonomy-label>windows</span></a></li><li><a class=taxonomy-term href=/zh/tags/wireguard/ data-taxonomy-term=wireguard><span class=taxonomy-label>wireguard</span></a></li><li><a class=taxonomy-term href=/zh/tags/wsl/ data-taxonomy-term=wsl><span class=taxonomy-label>wsl</span></a></li><li><a class=taxonomy-term href=/zh/tags/zypper/ data-taxonomy-term=zypper><span class=taxonomy-label>zypper</span></a></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class="content container-fluid" id=content><div class="container-fluid post-card-holder" id=post-card-holder><div class=post-card><a href=/zh/posts/k8s/kubectl-plugins/ class=post-card-link><div class=card><div class=card-head><img class=card-img-top src=/zh/posts/k8s/kubectl-plugins/krew-banner.png alt="Hero Image"></div><div class=card-body><h5 class=card-title>扩展你的KUBECTL功能</h5><p class="card-text post-summary">随着 Kubernetes 成为主流的应用容器编排平台，其命令行客户端 kubectl 也成为了我们日常部署应用，维护集群最常用的工具。
kubectl 自身提供了强大的内置自命令来满足我们对集群的操作，例如 get 获取集群内的资源对象，proxy 创建代理之类的，除了内置的这些自命令，kubectl 还提供了可扩展的能力，允许我们安装自己编写或者社区提供的插件来增强我们使用 kubectl 的生产力。
这里将给大家介绍如何在安装 kubectl 扩展插件，以及几款我在日常工作中常用到的社区提供的插件。
在安装和使用 kubectl 插件的之前，请确保以及安装和配置好 kubectl 命令行工具和 git 工具。
krew 首先介绍的第一款扩展插件就是 krew - k8s特别兴趣小组开发的一款用于安装和管理 kubectl 扩展插件的插件。
代码： https://github.com/kubernetes-sigs/krew
安装 krew (在macOS/Linux上):
在终端执行（Bash或者Zsh）执行 ( set -x; cd "$(mktemp -d)" && OS="$(uname | tr '[:upper:]' '[:lower:]')" && ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/\(arm\)\(64\)\?.*/\1\2/' -e 's/aarch64$/arm64/')" && KREW="krew-${OS}_${ARCH}" && curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" && tar zxvf "${KREW}.tar.gz" && .</p></div><div class=card-footer><span class=float-left>July 4, 2022</span>
<a href=/zh/posts/k8s/kubectl-plugins/ class="float-right btn btn-outline-info btn-sm">Read</a></div></div></a></div><div class=post-card><a href=/zh/posts/k8s/health-checks/ class=post-card-link><div class=card><div class=card-head><img class=card-img-top src=/zh/posts/k8s/health-checks/kubernetes-health-checks.png alt="Hero Image"></div><div class=card-body><h5 class=card-title>K8S健康检查最佳实践</h5><p class="card-text post-summary">我们都知道分布式系统非常难以管理，很大的一个原因是要是整个系统的可用性，是需要所有的部件（服务）都正常工作。如果一个小的部件不可用，系统应该可以检测到，绕过该部件，然后修复它，而且这样的行为应该可以自动进行。
健康检查就是一个简单方法，使系统可以知道应用（服务）的一个实例是否正常工作。如果一个实例能正常工作，那其他服务不应该访问它或者向它发送请求，请求应该发送到健康的实例。而系统应该恢复应用的监控状态。
当我们使用 Kubernetes 来运行和管理我们的应用（服务），默认情况下当一个Pod里的所有容器都启动后，就向该Pod发送相应的流量，并且当容器崩溃的时候重启容器。在一般情况下，这个行为也是可以接受的，不过k8s还提供了对容器的健康检查机制，可以让我们的部署更加健壮。
在演示如何具体配置K8S的健康检查之前，让我们来看看什么健康探测模式（Health Probe Pattern）?
健康探测模式 当我们设计一个关键任务，高可用的应用时，弹性是我们需要考虑的最重要方面之一。当一个应用能快速从失败中恢复，那个这个应用就是具有弹性的。
为了保证基于k8s部署的应用是高可用的，在设计集群时，我们需要遵从特定的设计模式。而健康探测就是其中的一种模式，它定义了应用如何向系统（k8s）报告它自己的健康状态。
这里所谓的健康状态不仅仅是Pod是否启动及运行，还应包括其是否可以正常处理请求并响应，这样k8s就可以更加合理地进行流量路由以及负载均衡。
Kubernetes的健康探测 我们都知道，k8s通过各种控制器对象（Deployment, StatefulSets等）来监控Pod的状态，如果一个控制器检测到Pod由于某些原因崩溃，它就会尝试重新启动Pod，或者把Pod调度到其他节点上进行启动。然而，Pod是可以报告自己的状态的，例如一个使用Nginx作为web服务器的应用，通过Deployment部署到集群里并正常启动，这个时候检测到Pod的的状态是运行着的，但是可能由于某些原因导致访问web服务时确返回500（内部服务错误），对请求者来说该服务是不可用的状态。
默认情况下，k8s的kubelet继续地探测容器的进程，当探测到进程退出，它会重启容器的Pod，有些情况下重启可以让容器恢复正常。但像上面的例子，容器的进行正常运行，而应用却返回500错误，并不能正确地探测到应用的健康状态。
因此，k8s提供了两个类型的探测： 存活探测（Liveness Probe），就绪探测（Readiness Probe）。
存活探测（Liveness Probe） 很多应用在长时间运行，或者遇到某种错误进入死锁状态，除非重启，否则无法恢复。因此k8s提供存活探测（Liveness Probe）来发现并恢复这种状态，当然存活探测检查到错误时，kubelet将对Pod采取重启操作来恢复应用
就绪探测（Readiness Probe） 有时应用会暂时性的不能对外提供网络服务，例如在负载比较大的是偶，或者在应用启动的时候可能需要加载大量数据或做一些初始化的动作，需要一定时间来准备对外提供服务。
这样的情况下，系统探测到应用实例不可用时，不应该杀死应用重启，而是应该分配流量，不往该实例发送请求（通过配置服务负载）。
因此，k8s提供了就绪探测来发现并处理这种情况，发现Pod里的容器为就绪时，会设置应用的service(k8s资源对行)移除该实例的Endpoint（服务端点），使得流量然过该不可用的服务实例，等待探测起就绪后，再将其端点添加回相应的服务。当然如果应用是第一次启动，则会等待就绪探测成功后才会将其添加到服务端点。
Kubernetes探测方法 那系统如何来探测容器的健康状态呢？k8s支持配置三种探测方法： 执行命令，TCP，HTTP 。
三种方法都可以应用到存活和就绪探测。
执行命令 通过在容器内执行命令来判断容器的状态，如果命令返回值为 0，则认为容器是健康的；如果返回值为非 0，则认为容器是不健康的。
这种方式一般在容器运行的应用没有提供HTTP的服务，也没有任何TCP端口启动来提供服务的情况，而可以通过运行一个命令来确定应用是否健康。
下面是配置一个Pod使用命令
apiVersion: v1 kind: Pod metadata: name: app spec: containers: - image: example/app:v1 name: app livenessProbe: exec: command: - cat - /tmp/healthy initialDelaySeconds: 5 上面的示例就使用命令 cat /tmp/healthy 来进行存货探测，如果容器里不存在 /tmp/healthy 文件，则命令返回非0值，k8s则认为容器不健康，这里使用了存活探测，因此会重启该Pod。
TCP 那TCP方式，就是通过尝试向容器监听的端口建立TCP连接来确定其是否健康，如果能成功建立连接，则认为健康，否则不健康。</p></div><div class=card-footer><span class=float-left>December 8, 2020</span>
<a href=/zh/posts/k8s/health-checks/ class="float-right btn btn-outline-info btn-sm">Read</a></div></div></a></div></div><div class=paginator></div></div></section></div><footer id=footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/zh/#about>关于</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#skills>技能</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#experiences>工作经历</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#education>教育</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#recent-posts>近期文章</a></li><li class=nav-item><a class=smooth-scroll href=/zh/#accomplishments>技能学习</a></li><li class=nav-item><a class=smooth-scroll href=https://live.mengz.dev/>LiveTerm</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><ul><li><a href=mailto:mengz.you@outlook.com target=_blank rel=noopener><span><i class="fas fa-envelope"></i></span> <span>mengz.you@outlook.com</span></a></li><li><a href=https://github.com/mengzyou target=_blank rel=noopener><span><i class="fab fa-github"></i></span> <span>mengzyou</span></a></li><li><a href=https://www.linkedin.com/in/mengzyou target=_blank rel=noopener><span><i class="fab fa-linkedin"></i></span> <span>You Mengzhe</span></a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hugo-toha/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2023 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/application.d06ddacd4080231ac954a78539ea5f5a1921ebbd740618450ead7a0e8466dfda.js integrity="sha256-0G3azUCAIxrJVKeFOepfWhkh6710BhhFDq16DoRm39o=" defer></script></body></html>